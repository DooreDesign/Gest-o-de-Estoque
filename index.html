<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Door & Design - Gestão de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Configuração Visual -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            screens: {
              "3xl": "1920px",
            },
            colors: {
              primary: "#0f172a",
              brand: "#f97316",
              background: "#f8fafc",
              success: "#10b981",
              error: "#ef4444",
              text: "#334155",
              "text-light": "#64748b",
            },
            boxShadow: {
              card: "0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)",
              floating: "0 10px 30px -10px rgba(0,0,0,0.12)",
            },
          },
        },
      };
    </script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");
      html,
      body {
        overflow-x: hidden;
        max-width: 100vw;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
        color: #334155;
      }

      .fade-in {
        animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Scrollbar Personalizada */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      /* Navegação */
      .nav-link.active {
        background-color: #f1f5f9;
        color: #0f172a;
        font-weight: 600;
        position: relative;
      }
      .nav-link.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: #f97316;
        border-radius: 0 4px 4px 0;
      }

      .tab-btn {
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        color: #64748b;
        border-radius: 0.5rem;
      }
      .tab-btn:hover {
        color: #0f172a;
        background-color: #f1f5f9;
      }
      .tab-btn.active {
        border-bottom-color: #f97316;
        color: #0f172a;
        font-weight: 600;
        background-color: #fff7ed;
      }
      @media (min-width: 640px) {
        .tab-btn {
          border-radius: 0.5rem 0.5rem 0 0;
          border-bottom: 3px solid transparent;
        }
        .tab-btn:hover {
          background-color: #f8fafc;
        }
        .tab-btn.active {
          background-color: white;
          border-bottom-color: #f97316;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
      }
      @media (max-width: 639px) {
        .tab-btn {
          background-color: #f1f5f9;
          border-bottom: none;
          border-radius: 0.5rem;
        }
        .tab-btn:hover {
          background-color: #e2e8f0;
        }
        .tab-btn.active {
          background-color: #f97316;
          color: white;
        }
      }

      /* Imagens */
      .card-img-wrapper {
        height: 180px;
        background-color: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
      }
      @media (max-width: 640px) {
        .card-img-wrapper {
          height: 120px;
        }
      }
      .card-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        /* faster transform to avoid perceived lag while scrolling */
        transition: transform 0.22s ease;
      }
      /* Help the browser reduce scroll jank on touch/desktop by keeping overscroll contained */
      #content-area {
        overscroll-behavior: contain;
      }
      /* Hint for smoother scroll/painting on many items */
      .inventory-card {
        will-change: transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        transform: translateZ(0);
      }
      .card-img {
        will-change: transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }
      .inventory-card:hover .card-img {
        transform: scale(1.08);
      }

      /* Toasts */
      #toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }
      @media (max-width: 640px) {
        #toast-container {
          bottom: calc(80px + env(safe-area-inset-bottom));
          right: 12px;
          left: 12px;
        }
      }
      .toast {
        pointer-events: auto;
        background: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #0f172a;
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        transform: translateX(120%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        font-size: 14px;
      }
      @media (max-width: 640px) {
        .toast {
          min-width: auto;
          width: 100%;
          padding: 12px 16px;
          font-size: 13px;
        }
      }
      .toast.show {
        transform: translateX(0);
      }

      /* Touch targets para mobile tabs */
      @media (max-width: 640px) {
        .tab-btn {
          min-width: auto;
          padding: 0.5rem 1rem;
          font-size: 0.75rem;
          white-space: nowrap;
          flex-shrink: 0;
        }
      }

      /* Hide scrollbar for tabs on mobile */
      .tabs-scroll {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .tabs-scroll::-webkit-scrollbar {
        display: none;
      }

      /* Mobile Sidebar Overlay */
      #sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 15;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      #sidebar-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      @media (min-width: 768px) {
        #sidebar-overlay {
          display: none;
        }
      }

      /* Sidebar Mobile */
      aside {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      @media (max-width: 767px) {
        aside {
          position: fixed;
          top: 0;
          left: 0;
          bottom: 0;
          transform: translateX(-100%);
          z-index: 20;
          width: 280px;
          max-width: 85vw;
        }
        aside.mobile-open {
          transform: translateX(0);
        }
        /* Prevent iOS zoom on inputs */
        input,
        select,
        textarea {
          font-size: 16px !important;
        }
      }

      /* Safe Area for iOS */
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
      }

      /* Ultrawide Container */
      .ultrawide-container {
        max-width: 1920px;
        margin-left: auto;
        margin-right: auto;
        width: 100%;
      }

      /* ========== ESTILOS LISTA DE COMPRAS ========== */
      /* Controles de pesquisa e filtros */
      #view-shopping header .no-print {
        display: block;
      }

      @media print {
        #view-shopping header .no-print {
          display: none !important;
        }
      }

      /* Item em trânsito - estilo visual */
      .shopping-item-in-transit {
        border-left: 4px solid #3b82f6 !important;
        background: linear-gradient(to right, #eff6ff 0%, #ffffff 10%) !important;
      }

      .shopping-item-in-transit .absolute.left-0 {
        background-color: #3b82f6 !important;
      }

      /* Badge "Em Trânsito" */
      .shopping-item-in-transit [class*="bg-blue-50"] {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      /* Responsividade dos filtros */
      @media (max-width: 640px) {
        #view-shopping header .flex-col.gap-2 {
          gap: 0.75rem;
        }
        
        #view-shopping header select,
        #view-shopping header input {
          font-size: 0.875rem;
        }
      }

      /* ========== ESTILOS DE IMPRESSÃO ========== */
      @media print {
        @page {
          size: A4 portrait;
          margin: 12mm 8mm;
        }

        /* Reset geral */
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        /* Ocultar elementos desnecessários */
        body {
          background: white !important;
          overflow: visible !important;
          height: auto !important;
          font-size: 10pt !important;
        }

        aside,
        #sidebar-overlay,
        #loading-screen,
        #toast-container,
        #btn-scroll-top,
        .mobile-nav,
        nav[class*="md:hidden"],
        [class*="fixed bottom"],
        .no-print {
          display: none !important;
        }

        /* Container principal */
        main {
          width: 100% !important;
          max-width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
          overflow: visible !important;
          height: auto !important;
        }

        #content-area {
          overflow: visible !important;
          height: auto !important;
          padding: 0 !important;
        }

        /* Ocultar todas as views exceto shopping */
        .view-section {
          display: none !important;
        }

        #view-shopping {
          display: block !important;
          padding: 0 !important;
          margin: 0 !important;
        }

        /* Header da lista de compras */
        #view-shopping > header {
          background: none !important;
          border: none !important;
          box-shadow: none !important;
          padding: 0 !important;
          margin-bottom: 4mm !important;
          border-radius: 0 !important;
          display: block !important;
        }

        #view-shopping > header > div {
          width: 100% !important;
        }

        #view-shopping > header .print-title {
          font-size: 16pt !important;
          font-weight: 700 !important;
          color: #0f172a !important;
          margin: 0 0 1mm 0 !important;
          text-align: center !important;
          display: block !important;
          border-bottom: 1.5pt solid #0f172a !important;
          padding-bottom: 2mm !important;
        }

        #view-shopping > header .print-subtitle {
          display: block !important;
          font-size: 8pt !important;
          color: #64748b !important;
          text-align: center !important;
          margin-top: 1mm !important;
        }

        /* Esconder botão de imprimir */
        #view-shopping > header button {
          display: none !important;
        }

        /* Ocultar itens em trânsito na impressão */
        .shopping-item-in-transit {
          display: none !important;
        }

        /* Ocultar itens marcados para não imprimir */
        .print-hidden {
          display: none !important;
        }

        /* ===== TABELA DE ITENS ===== */
        #shopping-grid {
          display: table !important;
          width: 100% !important;
          border-collapse: collapse !important;
          margin-top: 3mm !important;
        }

        /* Cabeçalho da tabela (gerado via CSS) */
        #shopping-grid::before {
          content: "";
          display: table-row !important;
          background: #f1f5f9 !important;
          font-weight: 700 !important;
          font-size: 7pt !important;
          text-transform: uppercase !important;
          color: #475569 !important;
        }

        /* Cada item como linha de tabela */
        #shopping-grid > div {
          display: table-row !important;
          background: white !important;
          border: none !important;
          box-shadow: none !important;
          padding: 0 !important;
          margin: 0 !important;
          page-break-inside: avoid !important;
        }

        /* Ocultar elementos decorativos */
        #shopping-grid > div > .absolute,
        #shopping-grid > div::before {
          display: none !important;
        }

        /* Resetar todos os filhos como células */
        #shopping-grid > div > * {
          display: table-cell !important;
          vertical-align: middle !important;
          padding: 2mm 2mm !important;
          border-bottom: 0.5pt solid #e2e8f0 !important;
        }

        /* Primeira coluna - Checkbox */
        #shopping-grid > div::after {
          content: "☐" !important;
          display: table-cell !important;
          width: 6mm !important;
          text-align: center !important;
          font-size: 12pt !important;
          vertical-align: middle !important;
          padding: 2mm 1mm !important;
          border-bottom: 0.5pt solid #e2e8f0 !important;
        }

        /* Container da imagem */
        #shopping-grid > div > div:first-child {
          width: 12mm !important;
          padding: 1.5mm !important;
        }

        /* Imagem do item */
        #shopping-grid > div img {
          width: 8mm !important;
          height: 8mm !important;
          min-width: 8mm !important;
          max-width: 8mm !important;
          border-radius: 1mm !important;
          object-fit: cover !important;
        }

        /* Ícone placeholder quando não tem imagem */
        #shopping-grid
          > div
          > div:first-child
          > div:first-child
          > div:first-child {
          width: 8mm !important;
          height: 8mm !important;
          font-size: 6pt !important;
        }

        /* Ocultar versão mobile do nome */
        #shopping-grid > div > div:first-child > div:nth-child(2) {
          display: none !important;
        }

        /* Container de info desktop - Nome e detalhes */
        #shopping-grid > div > div.hidden.sm\\:flex,
        #shopping-grid > div > div:nth-child(2) {
          display: table-cell !important;
          width: auto !important;
          padding: 2mm 3mm !important;
        }

        /* Nome do item */
        #shopping-grid h4 {
          font-size: 9pt !important;
          font-weight: 600 !important;
          color: #0f172a !important;
          margin: 0 !important;
          line-height: 1.2 !important;
        }

        /* Info secundária (fornecedor, estoque) */
        #shopping-grid .text-text-light,
        #shopping-grid [class*="text-xs"] {
          font-size: 7pt !important;
          color: #64748b !important;
          margin-top: 0.5mm !important;
        }

        /* Coluna de quantidade sugerida */
        #shopping-grid > div > div:last-child {
          width: 22mm !important;
          text-align: right !important;
          padding-right: 2mm !important;
        }

        /* Label "Sugestão" */
        #shopping-grid > div > div:last-child > div:first-child {
          font-size: 6pt !important;
          color: #94a3b8 !important;
          text-transform: uppercase !important;
          margin-bottom: 0 !important;
        }

        /* Número da sugestão */
        #shopping-grid [class*="text-lg"],
        #shopping-grid [class*="text-xl"] {
          font-size: 11pt !important;
          font-weight: 700 !important;
          color: #0f172a !important;
        }

        /* Esconder botões de ação */
        #shopping-grid button {
          display: none !important;
        }

        /* Fundo alternado para linhas */
        #shopping-grid > div:nth-child(even) > * {
          background: #fafafa !important;
        }

        /* Estado vazio - ocultar */
        #empty-state-shopping {
          display: none !important;
        }

        /* Ocultar itens em trânsito na impressão */
        .shopping-item-in-transit {
          display: none !important;
        }

        /* Rodapé de impressão */
        #view-shopping::after {
          content: "Door & Design - Lista de Compras" !important;
          display: block !important;
          font-size: 7pt !important;
          color: #94a3b8 !important;
          text-align: center !important;
          margin-top: 5mm !important;
          padding-top: 3mm !important;
          border-top: 0.5pt solid #e2e8f0 !important;
        }
      }
    </style>
  </head>
  <body
    class="h-screen flex flex-col md:flex-row overflow-hidden bg-background"
  >
    <!-- Loading Overlay -->
    <div
      id="loading-screen"
      class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col transition-opacity duration-500"
    >
      <div
        class="w-12 h-12 border-4 border-brand border-t-transparent rounded-full animate-spin mb-4"
      ></div>
      <p class="text-sm font-bold text-primary animate-pulse">
        Conectando ao Banco de Dados...
      </p>
    </div>

    <div id="toast-container"></div>
    <div id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <!-- Sidebar -->
    <aside
      id="main-sidebar"
      class="w-full md:w-72 bg-white flex flex-col shadow-xl z-20 shrink-0 border-r border-slate-100"
    >
      <div
        class="h-24 flex items-center justify-center border-b border-slate-100 bg-white relative overflow-hidden"
      >
        <div
          class="absolute -top-10 -left-10 w-24 h-24 bg-orange-50 rounded-full blur-2xl opacity-50"
        ></div>
        <div class="flex items-center gap-3 relative z-10">
          <div class="flex flex-col leading-tight">
            <h1
              class="font-extrabold text-sm sm:text-base text-primary tracking-tight"
            >
              <span class="text-brand block text-lg sm:text-2xl leading-none"
                >Door & Design</span
              >
              <span
                class="block text-xs sm:text-sm text-slate-400 font-medium mt-0"
                >Gestão de Estoque</span
              >
            </h1>
          </div>
        </div>
      </div>

      <nav class="flex-1 py-6 space-y-1 overflow-y-auto px-4">
        <!-- Principal -->
        <div
          class="px-3 pt-2 pb-1 text-[11px] uppercase text-slate-400 font-semibold tracking-wider"
        >
          Principal
        </div>
        <div class="px-2">
          <button
            onclick="switchView('dashboard')"
            id="nav-dashboard"
            class="nav-link active w-full flex items-center gap-4 px-4 py-3 rounded-lg transition-all text-text-light hover:bg-slate-50 hover:text-primary"
          >
            <i class="fas fa-chart-pie w-5 text-center"></i>
            <span class="text-sm font-medium">Visão Geral</span>
          </button>
        </div>
        <!-- Gestão -->
        <div
          class="px-3 pt-3 pb-1 text-[11px] uppercase text-slate-400 font-semibold tracking-wider"
        >
          Gestão
        </div>
        <div class="px-2">
          <button
            onclick="switchView('inventory')"
            id="nav-inventory"
            class="nav-link w-full flex items-center gap-4 px-4 py-3 rounded-lg transition-all text-text-light hover:bg-slate-50 hover:text-primary"
          >
            <i class="fas fa-boxes w-5 text-center"></i>
            <span class="text-sm font-medium">Estoque</span>
          </button>
          <button
            onclick="switchView('shopping')"
            id="nav-shopping"
            class="nav-link w-full flex items-center gap-4 px-4 py-3 mt-1 rounded-lg transition-all text-text-light hover:bg-slate-50 hover:text-primary group"
          >
            <div class="relative w-5 text-center">
              <i
                class="fas fa-shopping-cart group-hover:text-brand transition-colors"
              ></i>
              <span
                id="badge-count"
                class="absolute -top-2 -right-2 bg-error text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full shadow-sm hidden scale-0 transition-transform duration-300"
                >0</span
              >
            </div>
            <span class="text-sm font-medium">Compras</span>
          </button>
        </div>
        <!-- Registros -->
        <div
          class="px-3 pt-3 pb-1 text-[11px] uppercase text-slate-400 font-semibold tracking-wider"
        >
          Registros
        </div>
        <div class="px-2">
          <button
            onclick="switchView('history')"
            id="nav-history"
            class="nav-link w-full flex items-center gap-4 px-4 py-3 rounded-lg transition-all text-text-light hover:bg-slate-50 hover:text-primary"
          >
            <i class="fas fa-history w-5 text-center"></i>
            <span class="text-sm font-medium">Histórico</span>
          </button>
        </div>
        <div class="my-4 border-t border-slate-100 mx-2"></div>
        <!-- Administração -->
        <div
          class="px-3 pt-3 pb-1 text-[11px] uppercase text-slate-400 font-semibold tracking-wider"
        >
          Administração
        </div>
        <div class="px-2">
          <button
            onclick="switchView('settings')"
            id="nav-settings"
            class="nav-link w-full flex items-center gap-4 px-4 py-3 rounded-lg transition-all text-text-light hover:bg-slate-50 hover:text-primary"
          >
            <i class="fas fa-cog w-5 text-center"></i>
            <span class="text-sm font-medium">Configurações</span>
          </button>
        </div>
      </nav>

      <!-- Sidebar footer: compact, connection + last sync + version (no user/actions) -->
      <div
        class="p-4 sm:p-5 border-t border-slate-100 bg-white sticky bottom-0"
      >
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <span
              id="sidebar-sync-indicator"
              class="w-2 h-2 rounded-full bg-red-400"
            ></span>
            <div>
              <div
                id="sidebar-status-text"
                class="text-xs font-semibold text-slate-700"
              >
                Offline
              </div>
              <div class="text-[10px] text-slate-400">
                Última Sincronização: <span id="sidebar-last-sync">—</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
      <!-- Topbar Mobile -->
      <header
        class="md:hidden bg-white px-4 h-16 shadow-sm flex justify-between items-center z-10 sticky top-0"
      >
        <div class="flex items-center gap-3">
          <div class="flex flex-col leading-tight">
            <span
              class="font-bold tracking-tight text-sm sm:text-base text-primary"
            >
              <span class="text-brand block text-lg sm:text-xl leading-none"
                >Door & Design</span
              >
              <span class="block text-xs text-slate-500 font-semibold mt-0"
                >Gestão de Estoque</span
              >
            </span>
          </div>
        </div>
        <button
          onclick="toggleMobileSidebar()"
          class="text-text-light p-2 hover:bg-slate-100 rounded-lg transition"
        >
          <i class="fas fa-bars text-lg"></i>
        </button>
      </header>

      <div
        id="content-area"
        class="flex-1 overflow-y-auto p-4 md:p-8 lg:p-10 relative scroll-smooth pb-safe"
        style="-webkit-overflow-scrolling: touch; scrollbar-gutter: stable"
      >
        <!-- DASHBOARD -->
        <div
          id="view-dashboard"
          class="view-section space-y-6 fade-in ultrawide-container"
        >
          <header class="flex justify-between items-end mb-2">
            <div>
              <h2 class="text-2xl font-bold text-primary">Dashboard</h2>
            </div>
            <div class="text-right hidden sm:block">
              <div class="text-xs font-bold text-slate-400 uppercase">Data</div>
              <div
                class="text-sm font-bold text-primary"
                id="dash-date-display"
              >
                ...
              </div>
            </div>
          </header>

          <!-- Metrics Grid -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Total Items -->
            <div
              class="bg-white p-4 rounded-2xl shadow-card border border-slate-100"
            >
              <div class="flex items-center gap-3 mb-2">
                <div
                  class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center"
                >
                  <i class="fas fa-box"></i>
                </div>
                <span class="text-xs font-bold text-slate-400 uppercase"
                  >Total</span
                >
              </div>
              <div
                class="text-2xl font-bold text-primary"
                id="dash-metric-total"
              >
                0
              </div>
            </div>
            <!-- Critical -->
            <div
              class="bg-white p-4 rounded-2xl shadow-card border border-slate-100"
            >
              <div class="flex items-center gap-3 mb-2">
                <div
                  class="w-8 h-8 rounded-lg bg-red-50 text-error flex items-center justify-center"
                >
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <span class="text-xs font-bold text-slate-400 uppercase"
                  >Críticos</span
                >
              </div>
              <div
                class="text-2xl font-bold text-error"
                id="dash-metric-critical"
              >
                0
              </div>
            </div>
            <!-- Entries -->
            <div
              class="bg-white p-4 rounded-2xl shadow-card border border-slate-100"
            >
              <div class="flex items-center gap-3 mb-2">
                <div
                  class="w-8 h-8 rounded-lg bg-emerald-50 text-success flex items-center justify-center"
                >
                  <i class="fas fa-arrow-down"></i>
                </div>
                <span class="text-xs font-bold text-slate-400 uppercase"
                  >Entradas</span
                >
              </div>
              <div
                class="text-2xl font-bold text-success"
                id="dash-metric-entries"
              >
                0
              </div>
            </div>
            <!-- Exits -->
            <div
              class="bg-white p-4 rounded-2xl shadow-card border border-slate-100"
            >
              <div class="flex items-center gap-3 mb-2">
                <div
                  class="w-8 h-8 rounded-lg bg-orange-50 text-brand flex items-center justify-center"
                >
                  <i class="fas fa-arrow-up"></i>
                </div>
                <span class="text-xs font-bold text-slate-400 uppercase"
                  >Saídas</span
                >
              </div>
              <div class="text-2xl font-bold text-brand" id="dash-metric-exits">
                0
              </div>
            </div>
          </div>

          <!-- Main Content Grid -->
          <div class="grid grid-cols-1 lg:grid-cols-3 3xl:grid-cols-4 gap-6">
            <!-- Left: Recent Activity (2 cols) -->
            <div
              class="lg:col-span-2 3xl:col-span-3 bg-white rounded-2xl shadow-card border border-slate-100 flex flex-col min-h-[300px] sm:min-h-[400px]"
            >
              <div
                class="p-4 sm:p-5 border-b border-slate-50 flex justify-between items-center"
              >
                <h3 class="font-bold text-primary text-sm sm:text-base">
                  Movimentações Recentes
                </h3>
                <button
                  onclick="switchView('history')"
                  class="text-xs font-bold text-brand hover:underline"
                >
                  Ver Tudo
                </button>
              </div>
              <div class="flex-1 overflow-auto">
                <!-- Mobile Cards -->
                <div id="dash-recent-cards" class="p-3 space-y-2 sm:hidden">
                  <!-- Cards renderizados pelo JS -->
                </div>
                <!-- Desktop Table -->
                <div class="hidden sm:block">
                  <table class="w-full text-left text-sm">
                    <thead
                      class="bg-slate-50 text-xs uppercase text-slate-400 font-semibold sticky top-0"
                    >
                      <tr>
                        <th class="p-4">Item</th>
                        <th class="p-4 text-center">Tipo</th>
                        <th class="p-4 text-right">Qtd</th>
                        <th class="p-4 text-right text-slate-300">
                          <i class="far fa-clock"></i>
                        </th>
                      </tr>
                    </thead>
                    <tbody
                      id="dash-recent-table"
                      class="divide-y divide-slate-50"
                    >
                      <!-- Rows -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Right: Quick Actions & Alerts (1 col) -->
            <div class="space-y-4 sm:space-y-6 relative">
              <!-- Quick Search Card -->
              <div
                class="bg-gradient-to-br from-slate-800 to-slate-900 text-white rounded-2xl shadow-floating p-4 sm:p-5"
              >
                <div class="flex items-center gap-2 mb-3">
                  <div
                    class="w-8 h-8 rounded-lg bg-brand/20 flex items-center justify-center"
                  >
                    <i class="fas fa-search text-brand text-sm"></i>
                  </div>
                  <div>
                    <h3 id="dash-quick-label" class="font-bold text-sm">
                      Busca Rápida
                    </h3>
                  </div>
                </div>

                <div class="relative">
                  <input
                    type="text"
                    id="dash-quick-search"
                    onkeyup="dashQuickSearch(this.value)"
                    onfocus="this.parentElement.querySelector('#dash-quick-results').classList.remove('hidden')"
                    aria-label="Buscar item"
                    aria-controls="dash-quick-results"
                    aria-expanded="false"
                    autocomplete="off"
                    class="w-full bg-white/10 border border-white/20 text-white placeholder-slate-400 rounded-xl py-2.5 pl-10 pr-4 text-sm focus:outline-none focus:bg-white/15 focus:border-brand transition"
                  />
                </div>

                <!-- Default hint -->
                <div
                  id="dash-quick-default"
                  class="mt-3 flex items-center justify-center gap-2 text-[11px] text-slate-400"
                >
                  <span
                    >Digite para buscar — clique em um resultado para abrir o
                    item.</span
                  >
                </div>
              </div>

              <!-- Results Dropdown - OUTSIDE the card to avoid overflow issues -->
              <div
                id="dash-quick-results"
                role="listbox"
                aria-labelledby="dash-quick-label"
                class="absolute top-[115px] left-0 right-0 mx-0 bg-white rounded-xl shadow-2xl border border-slate-200 overflow-hidden hidden max-h-72 overflow-y-auto text-slate-700"
                style="z-index: 50"
              ></div>

              <!-- Critical Stock List -->
              <div
                class="bg-white rounded-2xl shadow-card border border-slate-100 p-4 sm:p-5"
              >
                <div class="flex justify-between items-center mb-3 sm:mb-4">
                  <h3 class="font-bold text-slate-700 text-sm sm:text-base">
                    Reposição Necessária
                  </h3>
                  <span
                    class="bg-red-100 text-error text-xs font-bold px-2 py-1 rounded-lg"
                    id="dash-critical-badge"
                    >0</span
                  >
                </div>
                <div
                  id="dash-critical-list"
                  class="space-y-2 sm:space-y-3 max-h-[250px] sm:max-h-[300px] overflow-y-auto pr-1"
                >
                  <!-- Items -->
                </div>
                <button
                  onclick="switchView('shopping')"
                  class="w-full mt-3 sm:mt-4 py-2.5 text-xs font-bold text-slate-500 hover:text-primary border border-slate-200 rounded-lg hover:bg-slate-50 transition"
                >
                  Ver Lista de Compras
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- INVENTORY -->
        <div
          id="view-inventory"
          class="view-section hidden space-y-6 fade-in ultrawide-container"
        >
          <div
            class="flex flex-col gap-3 sm:gap-4 bg-white p-3 sm:p-4 rounded-2xl shadow-card border border-slate-100"
          >
            <div class="flex justify-between items-center">
              <h2 class="text-lg sm:text-2xl font-bold text-primary">
                Estoque
              </h2>
              <button
                onclick="openModal()"
                title="Adicionar"
                aria-label="Adicionar"
                class="md:hidden bg-primary hover:bg-slate-800 text-white p-2 sm:p-2.5 rounded-xl shadow-lg text-sm font-semibold transition flex items-center justify-center"
              >
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div
              class="flex flex-col gap-2 sm:flex-row sm:gap-3 w-full items-stretch sm:items-center"
            >
              <div class="relative flex-1 group w-full">
                <input
                  type="text"
                  id="search-input"
                  onkeyup="renderInventory()"
                  placeholder="Buscar..."
                  class="w-full h-10 pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 focus:border-brand focus:ring-4 focus:ring-brand/10 outline-none text-sm transition shadow-sm bg-white"
                />
                <i
                  class="fas fa-search absolute left-4 top-3 text-slate-400 group-focus-within:text-brand transition-colors"
                ></i>
              </div>
              <div class="flex gap-2 w-full sm:w-auto">
                <div class="relative flex-1 sm:flex-none">
                  <select
                    id="sort-select"
                    onchange="changeSort(this.value)"
                    class="h-10 w-full sm:w-auto pl-3 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-medium text-slate-600 focus:border-brand outline-none appearance-none cursor-pointer hover:bg-slate-50"
                  >
                    <option value="name_asc">A-Z</option>
                    <option value="name_desc">Z-A</option>
                    <option value="qty_desc">Maior Qtd</option>
                    <option value="qty_asc">Menor Qtd</option>
                  </select>
                  <i
                    class="fas fa-sort absolute right-3 top-3.5 text-slate-400 pointer-events-none text-xs"
                  ></i>
                </div>
                <div
                  class="flex bg-white rounded-xl border border-slate-200 p-1 h-10 items-center flex-shrink-0"
                >
                  <button
                    onclick="toggleViewMode('grid')"
                    id="btn-view-grid"
                    class="p-2 rounded-lg text-slate-400 hover:text-brand transition active-view h-8 w-8 flex items-center justify-center"
                  >
                    <i class="fas fa-th-large"></i>
                  </button>
                  <button
                    onclick="toggleViewMode('list')"
                    id="btn-view-list"
                    class="p-2 rounded-lg text-slate-400 hover:text-brand transition h-8 w-8 flex items-center justify-center"
                  >
                    <i class="fas fa-list"></i>
                  </button>
                </div>
              </div>
              <button
                onclick="openModal()"
                class="hidden md:flex bg-primary hover:bg-slate-800 text-white px-4 py-2.5 h-10 rounded-xl shadow-lg shadow-slate-200 text-sm font-semibold transition transform hover:-translate-y-0.5 items-center justify-center gap-2"
              >
                <i class="fas fa-plus"></i>
                <span>Adicionar</span>
              </button>
            </div>
          </div>
          <div
            class="flex bg-white sm:bg-slate-50/50 rounded-xl sm:rounded-none border border-slate-100 sm:border-0 sm:border-b sm:border-slate-200 overflow-x-auto gap-1 sm:gap-1 p-1.5 sm:p-0 sm:pb-0 tabs-scroll"
            id="category-tabs-container"
            style="-webkit-overflow-scrolling: touch"
          ></div>
          <div id="inventory-container" class="pb-20"></div>
        </div>

        <!-- SHOPPING LIST -->
        <div
          id="view-shopping"
          class="view-section hidden space-y-8 fade-in ultrawide-container"
        >
          <header
            class="flex flex-col gap-3 sm:gap-4 bg-white p-3 sm:p-4 rounded-2xl shadow-card border border-slate-100"
          >
            <div class="flex justify-between items-center">
              <h2
                class="text-lg sm:text-2xl font-bold text-primary print-title"
              >
                Central de Compras
              </h2>
              <button
                onclick="printShoppingList()"
                class="text-slate-500 hover:text-primary bg-slate-50 border border-slate-200 px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium transition flex items-center gap-2 no-print"
              >
                <i class="fas fa-print"></i> <span>Imprimir</span>
              </button>
            </div>
            <div class="no-print">
              <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full items-stretch sm:items-center">
                <div class="relative flex-1 group w-full sm:w-auto">
                  <input
                    type="text"
                    id="shopping-search-input"
                    onkeyup="renderShopping()"
                    placeholder="Buscar..."
                    class="w-full h-10 pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 focus:border-brand focus:ring-4 focus:ring-brand/10 outline-none text-sm transition shadow-sm bg-white"
                  />
                  <i
                    class="fas fa-search absolute left-4 top-3 text-slate-400 group-focus-within:text-brand transition-colors"
                  ></i>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto sm:flex-shrink-0">
                  <div class="relative w-full sm:w-auto">
                    <select
                      id="shopping-filter-category"
                      onchange="renderShopping()"
                      class="h-10 w-full sm:w-auto sm:min-w-[160px] pl-3 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-medium text-slate-600 focus:border-brand outline-none appearance-none cursor-pointer hover:bg-slate-50"
                    >
                      <option value="">Todas as Categorias</option>
                    </select>
                    <i
                      class="fas fa-chevron-down absolute right-3 top-3.5 text-slate-400 pointer-events-none text-xs"
                    ></i>
                  </div>
                  <div class="relative w-full sm:w-auto">
                    <select
                      id="shopping-filter-supplier"
                      onchange="renderShopping()"
                      class="h-10 w-full sm:w-auto sm:min-w-[160px] pl-3 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-medium text-slate-600 focus:border-brand outline-none appearance-none cursor-pointer hover:bg-slate-50"
                    >
                      <option value="">Todos os Fornecedores</option>
                    </select>
                    <i
                      class="fas fa-chevron-down absolute right-3 top-3.5 text-slate-400 pointer-events-none text-xs"
                    ></i>
                  </div>
                  <div class="relative w-full sm:w-auto">
                    <select
                      id="shopping-filter-status"
                      onchange="renderShopping()"
                      class="h-10 w-full sm:w-auto sm:min-w-[140px] pl-3 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-medium text-slate-600 focus:border-brand outline-none appearance-none cursor-pointer hover:bg-slate-50"
                    >
                      <option value="all">Todos</option>
                      <option value="pending">Pendentes</option>
                      <option value="inTransit">Em Trânsito</option>
                    </select>
                    <i
                      class="fas fa-chevron-down absolute right-3 top-3.5 text-slate-400 pointer-events-none text-xs"
                    ></i>
                  </div>
                </div>
              </div>
            </div>
            <p class="text-xs text-slate-400 mt-1 print-subtitle hidden"></p>
          </header>
          <div id="shopping-grid" class="space-y-4 print-list"></div>
          <div
            id="empty-state-shopping"
            class="hidden flex flex-col items-center justify-center py-24 text-center"
          >
            <div
              class="w-20 h-20 bg-emerald-50 rounded-full flex items-center justify-center mb-6 shadow-sm"
            >
              <i class="fas fa-check text-3xl text-success"></i>
            </div>
            <h3 class="text-xl font-bold text-primary">Estoque Abastecido!</h3>
          </div>
        </div>

        <!-- HISTORY -->
        <div
          id="view-history"
          class="view-section hidden space-y-4 sm:space-y-6 fade-in ultrawide-container"
        >
          <header
            class="bg-white p-3 sm:p-4 rounded-2xl shadow-card border border-slate-100"
          >
            <h2 class="text-lg sm:text-2xl font-bold text-primary">
              Histórico de Movimentações
            </h2>
          </header>
          <!-- Mobile: Cards View -->
          <div id="history-cards-mobile" class="space-y-3 sm:hidden"></div>
          <!-- Desktop: Table View -->
          <div
            class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden hidden sm:block"
          >
            <table class="w-full text-left text-sm">
              <thead
                class="bg-slate-50/80 border-b border-slate-100 text-text-light font-semibold uppercase text-xs tracking-wider"
              >
                <tr>
                  <th class="p-4">Data</th>
                  <th class="p-4">Item</th>
                  <th class="p-4 text-center">Tipo</th>
                  <th class="p-4 hidden md:table-cell">Detalhes</th>
                  <th class="p-4 text-right">Qtd</th>
                </tr>
              </thead>
              <tbody
                id="history-table-body"
                class="divide-y divide-slate-50 text-slate-700"
              ></tbody>
            </table>
          </div>
          <div
            id="empty-history"
            class="p-8 sm:p-12 text-center text-text-light hidden bg-white rounded-2xl shadow-card border border-slate-100"
          >
            Nenhum registro encontrado.
          </div>
        </div>

        <!-- SETTINGS -->
        <div
          id="view-settings"
          class="view-section hidden space-y-4 sm:space-y-6 fade-in ultrawide-container"
        >
          <header
            class="bg-white p-3 sm:p-4 rounded-2xl shadow-card border border-slate-100"
          >
            <h2 class="text-lg sm:text-2xl font-bold text-primary">
              Configurações
            </h2>
          </header>
          <div class="grid grid-cols-1 gap-4 sm:gap-6">
            <div
              class="bg-white p-4 sm:p-6 rounded-2xl shadow-card border border-slate-100"
            >
              <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 sm:mb-6"
              >
                <div>
                  <h3
                    class="font-bold text-base sm:text-lg text-primary flex items-center gap-2"
                  >
                    <i class="fas fa-layer-group text-brand"></i> Categorias
                  </h3>
                </div>
                <button
                  onclick="openCategoryModal()"
                  class="bg-slate-900 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm hover:bg-slate-800 transition shadow-lg shadow-slate-200 w-full sm:w-auto justify-center flex items-center gap-2"
                >
                  <i class="fas fa-plus"></i> <span>Adicionar</span>
                </button>
              </div>
              <div
                class="overflow-x-auto rounded-xl border border-slate-100"
                style="-webkit-overflow-scrolling: touch"
              >
                <table class="w-full text-sm text-left min-w-[300px]">
                  <thead
                    class="bg-slate-50 text-xs font-bold text-text-light uppercase"
                  >
                    <tr>
                      <th class="p-3 sm:p-4">Nome</th>
                      <th class="p-3 sm:p-4 text-center">Itens</th>
                      <th class="p-3 sm:p-4 text-right">Ações</th>
                    </tr>
                  </thead>
                  <tbody
                    id="category-table-body"
                    class="divide-y divide-slate-50 bg-white"
                  ></tbody>
                </table>
              </div>
            </div>
            <div
              class="bg-white p-4 sm:p-6 rounded-2xl shadow-card border border-slate-100"
            >
              <h3 class="font-bold text-base sm:text-lg text-primary mb-2">
                Status da Nuvem
              </h3>
              <p class="text-xs sm:text-sm text-slate-500 mb-3 sm:mb-4">
                Seus dados estão seguros nos servidores do Google.
              </p>
              <div
                class="flex items-center gap-2 text-success font-bold bg-green-50 p-3 rounded-xl border border-green-100 text-sm"
              >
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Sincronizado</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Floating back-to-top button (shows while content-area is scrolled) -->
      <button
        id="btn-scroll-top"
        title="Voltar ao Topo"
        aria-label="Voltar ao Topo"
        class="hidden fixed bottom-20 sm:bottom-6 right-4 sm:right-6 z-40 bg-primary text-white w-10 h-10 sm:w-11 sm:h-11 rounded-full shadow-lg flex items-center justify-center hover:bg-slate-800 transition-opacity duration-300 opacity-0 pointer-events-none"
      >
        <i class="fas fa-arrow-up"></i>
      </button>
    </main>

    <!-- Modals -->
    <div
      id="modal-form"
      class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 sm:p-4 transition-opacity opacity-0"
    >
      <div
        class="bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full max-w-2xl transform scale-95 transition-all flex flex-col max-h-[95vh] sm:max-h-[90vh]"
      >
        <div
          class="px-4 py-3 sm:px-6 sm:py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-xl sm:rounded-t-2xl"
        >
          <h3
            class="text-lg sm:text-xl font-bold text-primary"
            id="modal-title"
          >
            Novo Item
          </h3>
          <button
            onclick="closeModal()"
            class="text-slate-400 hover:text-primary transition bg-white px-3 py-2 rounded-full shadow-sm hover:shadow"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="p-4 sm:p-8 overflow-y-auto">
          <!-- destaque do nome do item (visível apenas em edição) -->
          <div id="form-item-name-container" class="mb-4 hidden">
            <p
              id="form-item-name"
              class="text-lg font-extrabold text-primary leading-tight"
            ></p>
          </div>
          <form
            id="item-form"
            onsubmit="handleFormSubmit(event)"
            class="space-y-6"
          >
            <input type="hidden" id="editItemId" />
            <div class="flex flex-col gap-5 sm:gap-8">
              <div class="w-full">
                <label
                  class="block text-xs font-bold text-text-light uppercase tracking-wide mb-2"
                  >Imagem</label
                >
                <div
                  id="upload-area"
                  class="border-2 border-dashed border-slate-300 rounded-2xl bg-slate-50 h-40 sm:h-48 flex flex-col items-center justify-center cursor-pointer hover:border-brand hover:bg-orange-50 transition relative overflow-hidden group"
                  onclick="document.getElementById('fileInput').click()"
                  role="button"
                  aria-label="Adicionar imagem: arraste ou clique"
                >
                  <input
                    type="file"
                    id="fileInput"
                    accept="image/*"
                    class="hidden"
                    onchange="processImage(this)"
                  />
                  <div
                    id="upload-placeholder"
                    class="text-center p-4 transition-opacity group-hover:opacity-70"
                  >
                    <div
                      class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-slate-400 mx-auto mb-3"
                    >
                      <i class="fas fa-camera text-xl"></i>
                    </div>
                    <p class="text-xs text-slate-500 font-medium">
                      Clique ou arraste uma imagem
                    </p>
                  </div>
                  <div
                    id="upload-processing"
                    class="absolute inset-0 bg-black/40 flex items-center justify-center text-white text-sm gap-3 hidden z-30"
                  >
                    <svg
                      class="animate-spin w-6 h-6"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                    >
                      <circle
                        class="opacity-25"
                        cx="12"
                        cy="12"
                        r="10"
                        stroke="currentColor"
                        stroke-width="4"
                      ></circle>
                      <path
                        class="opacity-75"
                        fill="currentColor"
                        d="M4 12a8 8 0 018-8v8z"
                      ></path>
                    </svg>
                    <span>Processando imagem…</span>
                  </div>
                  <div
                    id="upload-info"
                    class="text-xs text-slate-400 mt-2 hidden z-20 p-2"
                  ></div>
                  <img
                    id="img-preview"
                    class="hidden w-full h-full object-contain absolute inset-0 z-10 bg-white p-2 cursor-pointer"
                    onclick="openImageModal(this.src)"
                    alt="Preview da imagem selecionada"
                  />
                  <button
                    type="button"
                    id="btn-remove-img"
                    onclick="removeImage(event)"
                    class="hidden absolute top-2 right-2 z-20 bg-white text-error rounded-full w-8 h-8 items-center justify-center shadow-md hover:bg-slate-50 transition"
                    aria-label="Remover imagem"
                  >
                    <i class="fas fa-trash-alt text-sm"></i>
                  </button>
                </div>
                <input type="hidden" id="imgBase64" />
              </div>
              <div class="w-full space-y-4 sm:space-y-5">
                <div>
                  <label
                    class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                    >Nome *</label
                  ><input
                    type="text"
                    id="inpName"
                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-brand outline-none"
                    required
                  />
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-5">
                  <div>
                    <label
                      class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                      >Categoria *</label
                    >
                    <div class="relative">
                      <select
                        id="inpCategory"
                        class="w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-brand outline-none bg-white appearance-none cursor-pointer"
                      ></select
                      ><i
                        class="fas fa-chevron-down absolute right-4 top-3 text-slate-400 text-xs pointer-events-none"
                      ></i>
                    </div>
                  </div>
                  <div>
                    <label
                      class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                      >Tag</label
                    ><input
                      type="text"
                      id="inpTag"
                      class="w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-brand outline-none"
                    />
                  </div>
                </div>
                <div>
                  <label
                    class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                    >Fornecedor</label
                  >
                  <div class="relative">
                    <i
                      class="fas fa-truck absolute left-4 top-3 text-slate-400 text-sm"
                    ></i
                    ><input
                      type="text"
                      id="inpSupplier"
                      class="w-full pl-10 px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-brand outline-none"
                    />
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3 sm:gap-5 pt-2">
                  <div
                    class="bg-slate-50 p-3 rounded-xl border border-slate-100"
                  >
                    <label
                      class="block text-[10px] font-bold text-slate-500 uppercase mb-1"
                      >Atual</label
                    ><input
                      type="number"
                      id="inpQty"
                      placeholder="0"
                      class="w-full bg-transparent font-bold text-lg sm:text-xl text-primary outline-none"
                      required
                      min="0"
                    />
                  </div>
                  <div class="bg-red-50 p-3 rounded-xl border border-red-100">
                    <label
                      class="block text-[10px] font-bold text-error uppercase mb-1"
                      >Mínimo</label
                    ><input
                      type="number"
                      id="inpMin"
                      placeholder="1"
                      class="w-full bg-transparent font-bold text-lg sm:text-xl text-error outline-none"
                      required
                      min="1"
                    />
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div
          class="px-4 py-3 sm:px-6 sm:py-4 bg-slate-50 border-t border-slate-100 rounded-b-xl sm:rounded-b-2xl"
        >
          <div class="flex flex-col sm:flex-row sm:justify-end gap-3">
            <button
              onclick="closeModal()"
              class="w-full sm:w-auto px-4 py-2.5 border border-slate-200 rounded-xl text-sm font-semibold text-slate-600 hover:bg-white hover:border-slate-300 transition shadow-sm"
            >
              Cancelar
            </button>
            <button
              onclick="document.getElementById('item-form').requestSubmit()"
              class="w-full sm:w-auto px-4 py-2.5 bg-primary text-white rounded-xl text-sm font-semibold hover:bg-slate-800 shadow-lg shadow-slate-200 transition transform active:scale-95"
            >
              Salvar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="modal-category"
      class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity opacity-0"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-all"
      >
        <div
          class="p-6 border-b border-slate-100 flex justify-between items-center"
        >
          <h3 class="text-lg font-bold text-primary" id="cat-modal-title">
            Categoria
          </h3>
          <button
            onclick="closeCategoryModal()"
            class="text-slate-400 hover:text-primary"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="p-6">
          <form id="cat-form" onsubmit="handleCategorySubmit(event)">
            <input type="hidden" id="editCatOldName" /><label
              class="block text-xs font-bold text-text-light uppercase tracking-wide mb-2"
              >Nome</label
            ><input
              type="text"
              id="catNameInput"
              class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm focus:border-brand outline-none mb-6"
              required
            /><button
              type="submit"
              class="w-full bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-slate-800 transition"
            >
              Salvar
            </button>
          </form>
        </div>
      </div>
    </div>

    <div
      id="modal-receive"
      class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 sm:p-4 transition-opacity opacity-0"
    >
      <div
        class="bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full max-w-2xl transform scale-95 transition-all flex flex-col max-h-[85vh] sm:max-h-[80vh]"
      >
        <div
          class="px-4 py-3 sm:px-6 sm:py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-xl sm:rounded-t-2xl"
        >
          <h3 class="text-lg sm:text-xl font-bold text-primary">
            Receber Item
          </h3>
          <button
            onclick="closeReceiveModal()"
            class="text-slate-400 hover:text-primary transition bg-white px-3 py-2 rounded-full shadow-sm hover:shadow"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="p-4 sm:p-8 overflow-y-auto">
          <div class="mb-4">
            <p
              id="receive-item-name"
              class="text-lg font-bold text-primary leading-tight"
            >
              Item
            </p>
          </div>

          <form
            id="receive-form"
            onsubmit="handleReceiveSubmit(event)"
            class="space-y-4"
          >
            <input type="hidden" id="receiveItemId" />
            <div>
              <label
                class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                >Qtd Recebida</label
              >
              <input
                type="number"
                id="receiveQty"
                class="w-full px-4 py-3 border border-slate-200 rounded-xl text-lg font-bold text-primary focus:border-success outline-none"
                required
                min="1"
              />
              <!-- sugestão removida da visualização (valor continua pré-preenchido em receiveQty) -->
            </div>
          </form>
        </div>

        <div
          class="px-4 py-3 sm:px-6 sm:py-4 bg-slate-50 border-t border-slate-100 rounded-b-xl sm:rounded-b-2xl"
        >
          <div class="flex flex-col sm:flex-row sm:justify-end gap-3">
            <button
              onclick="closeReceiveModal()"
              class="w-full sm:w-auto px-4 py-2.5 border border-slate-200 rounded-xl text-sm font-semibold text-slate-600 hover:bg-white hover:border-slate-300 transition shadow-sm"
            >
              Cancelar
            </button>
            <button
              onclick="document.getElementById('receive-form').requestSubmit()"
              class="w-full sm:w-auto bg-success text-white px-5 py-2.5 rounded-xl shadow-lg hover:bg-emerald-600 transition text-sm font-bold flex items-center gap-2 justify-center"
            >
              <i class="fas fa-check"></i>
              Confirmar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Viewer Modal -->
    <div
      id="modal-image"
      class="fixed inset-0 bg-black/70 z-[100] hidden flex items-center justify-center p-4 transition-opacity opacity-0"
      onclick="closeImageModal()"
    >
      <div
        class="max-w-4xl max-h-full transform scale-95 transition-all"
        onclick="event.stopPropagation()"
      >
        <img
          id="modal-image-src"
          src=""
          class="max-w-full max-h-[90vh] rounded-lg shadow-2xl"
        />
        <button
          onclick="closeImageModal()"
          class="absolute top-4 right-4 text-white text-2xl hover:text-slate-200 transition"
        >
          &times;
        </button>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        doc,
        updateDoc,
        deleteDoc,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // CONFIGURAÇÃO DO FIREBASE
      let firebaseConfig;
      if (typeof __firebase_config !== "undefined") {
        firebaseConfig = JSON.parse(__firebase_config);
      } else {
        // --- COLE SUAS CHAVES AQUI ---
        firebaseConfig = {
          apiKey: "AIzaSyDncL4re72Cf9A3fBH2sf_PwhHNTKPWLC0",
          authDomain: "ded-gestao-de-estoque.firebaseapp.com",
          projectId: "ded-gestao-de-estoque",
          storageBucket: "ded-gestao-de-estoque.firebasestorage.app",
          messagingSenderId: "21564288686",
          appId: "1:21564288686:web:1827ddc1b12ecd7ad4073f",
        };
      }

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "door-design-matriz";

      let inventory = [],
        categories = [],
        historyLog = [],
        activeTab = "Todas";
      let viewMode = localStorage.getItem("dd_view_mode") || "grid",
        sortMode = "name_asc",
        categoryChartInstance = null;
      let quickActionSelectedId = null;

      // app metadata (displayed in sidebar footer)
      const APP_VERSION = "v1.0.0";

      // Update the compact sidebar footer status
      function updateSidebarStatus(connected, lastSync = null) {
        const indicator = document.getElementById("sidebar-sync-indicator");
        const statusText = document.getElementById("sidebar-status-text");
        const lastSyncEl = document.getElementById("sidebar-last-sync");
        const versionEl = document.getElementById("sidebar-version");

        if (indicator) {
          indicator.classList.toggle("bg-emerald-400", !!connected);
          indicator.classList.toggle("bg-red-400", !connected);
        }
        if (statusText)
          statusText.textContent = connected ? "Conectado" : "Offline";
        if (lastSyncEl)
          lastSyncEl.textContent = lastSync
            ? new Date(lastSync).toLocaleString("pt-BR")
            : "—";
        if (versionEl) versionEl.textContent = APP_VERSION;
      }

      async function initApp() {
        try {
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          )
            await signInWithCustomToken(auth, __initial_auth_token);
          else await signInAnonymously(auth);

          setupRealtimeListeners();
          // mark connected and set initial last-sync time on successful init
          try {
            updateSidebarStatus(true, new Date());
          } catch (e) {}
          document
            .getElementById("loading-screen")
            .classList.add("opacity-0", "pointer-events-none");

          // Expose Globals
          Object.assign(window, {
            openModal,
            closeModal,
            processImage,
            removeImage,
            handleFormSubmit,
            deleteItem,
            updateStockDirect,
            switchView,
            toggleViewMode,
            changeSort,
            renderInventory,
            renderShopping,
            openCategoryModal,
            closeCategoryModal,
            handleCategorySubmit,
            deleteCategory,
            openReceiveModal,
            closeReceiveModal,
            handleReceiveSubmit,
            setActiveTab,
            prepareEdit,
            toggleMobileSidebar,
            openImageModal,
            closeImageModal,
            dashQuickSearch,
            openQuickItem,
            printShoppingList,
            toggleInTransit,
          });

          switchView("dashboard");
          // initialize floating scroll-to-top behavior
          try {
            setupScrollTop();
          } catch (e) {}
          try {
            setupImageUploadUI();
          } catch (e) {}
        } catch (error) {
          console.error("Auth Err", error);
          // show offline status if auth/setup failed
          try {
            updateSidebarStatus(false, null);
          } catch (e) {}
        }
      }

      function setupRealtimeListeners() {
        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "inventory"),
          (snap) => {
            inventory = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
            renderGlobalUI();
            try {
              updateSidebarStatus(true, new Date());
            } catch (e) {}
          }
        );
        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "categories"),
          (snap) => {
            const docs = snap.docs.map((doc) => doc.data().name);
            categories =
              docs.length > 0
                ? docs
                : ["Geral", "Portas", "Fechaduras", "Ferragens"];
            renderCategoryTabs();
            renderCategoryTable();
            updateGlobalCharts();
            try {
              updateSidebarStatus(true, new Date());
            } catch (e) {}
          }
        );
        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "history"),
          (snap) => {
            historyLog = snap.docs
              .map((doc) => ({ id: doc.id, ...doc.data() }))
              .sort((a, b) => new Date(b.date) - new Date(a.date));
            renderHistory();
            try {
              updateSidebarStatus(true, new Date());
            } catch (e) {}
          }
        );
      }

      async function logAction(itemName, action, change, details = "") {
        try {
          await addDoc(
            collection(db, "artifacts", appId, "public", "data", "history"),
            {
              date: new Date().toISOString(),
              itemName,
              action,
              change,
              details,
            }
          );
        } catch (e) {}
      }

      async function handleFormSubmit(e) {
        e.preventDefault();
        const id = document.getElementById("editItemId").value;
        const data = {
          name: document.getElementById("inpName").value,
          category: document.getElementById("inpCategory").value,
          tag: document.getElementById("inpTag").value,
          supplier: document.getElementById("inpSupplier").value,
          qty: parseInt(document.getElementById("inpQty").value),
          min: parseInt(document.getElementById("inpMin").value),
          image: document.getElementById("imgBase64").value || null,
          updatedAt: new Date().toISOString(),
        };
        try {
          if (id) {
            // Buscar item antigo para calcular diferença
            const oldItem = inventory.find((i) => i.id === id);
            const oldQty = oldItem ? oldItem.qty : 0;
            const qtyChange = data.qty - oldQty;
            
            await updateDoc(
              doc(db, "artifacts", appId, "public", "data", "inventory", id),
              data
            );
            
            // Registrar edição com a diferença de quantidade
            const details = qtyChange !== 0 
              ? `De ${oldQty} para ${data.qty}` 
              : "Sem alteração de quantidade";
            logAction(data.name, "Edição", qtyChange, details);
            showToast("Item atualizado!", "success");
          } else {
            data.createdAt = new Date().toISOString();
            await addDoc(
              collection(db, "artifacts", appId, "public", "data", "inventory"),
              data
            );
            logAction(data.name, "Criação", data.qty);
            showToast("Item criado!", "success");
          }
          closeModal();
        } catch (err) {
          alert("Erro: " + err.message);
        }
      }

      async function updateStockDirect(id, change) {
        const item = inventory.find((i) => i.id === id);
        if (!item) return;
        try {
          const newQty = Math.max(0, item.qty + change);
          await updateDoc(
            doc(db, "artifacts", appId, "public", "data", "inventory", id),
            { qty: newQty }
          );
          logAction(item.name, change > 0 ? "Ajuste (+)" : "Retirada", change);
          showToast(`Estoque: ${newQty}`, "success");
        } catch (e) {
          alert("Erro conexão");
        }
      }

      async function deleteItem(id) {
        if (!confirm("Excluir?")) return;
        const item = inventory.find((i) => i.id === id);
        try {
          await deleteDoc(
            doc(db, "artifacts", appId, "public", "data", "inventory", id)
          );
          logAction(item ? item.name : "Item", "Exclusão", 0);
          showToast("Excluído", "default");
        } catch (e) {
          alert(e.message);
        }
      }

      async function handleReceiveSubmit(e) {
        e.preventDefault();
        const id = document.getElementById("receiveItemId").value;
        const qty = parseInt(document.getElementById("receiveQty").value);
        const item = inventory.find((i) => i.id === id);
        if (item && qty > 0) {
          try {
            // Resetar inTransit quando o item é recebido
            await updateDoc(
              doc(db, "artifacts", appId, "public", "data", "inventory", id),
              { qty: item.qty + qty, inTransit: false }
            );
            // registra o recebimento (sem custo) no histórico
            logAction(item.name, "Recebimento", qty);
            showToast("Recebido!", "success");
            closeReceiveModal();
          } catch (err) {
            alert("Erro ao receber");
          }
        }
      }

      async function toggleInTransit(itemId) {
        const item = inventory.find((i) => i.id === itemId);
        if (!item) return;
        try {
          const newInTransit = !(item.inTransit || false);
          await updateDoc(
            doc(db, "artifacts", appId, "public", "data", "inventory", itemId),
            { inTransit: newInTransit }
          );
          showToast(
            newInTransit ? "Marcado como em trânsito" : "Removido de trânsito",
            "success"
          );
        } catch (err) {
          alert("Erro ao atualizar status");
        }
      }

      async function handleCategorySubmit(e) {
        e.preventDefault();
        const newName = document.getElementById("catNameInput").value.trim();
        if (!newName || categories.includes(newName)) return alert("Inválido");
        try {
          await addDoc(
            collection(db, "artifacts", appId, "public", "data", "categories"),
            { name: newName }
          );
          showToast("Categoria criada", "success");
          closeCategoryModal();
        } catch (err) {}
      }
      async function deleteCategory(catName) {
        alert(
          "Exclusão de categorias deve ser feita no painel admin para segurança."
        );
      }

      function renderGlobalUI() {
        renderInventory();
        renderShopping();
        renderHistory();
        updateDashboard();
      }

      function renderInventory() {
        const container = document.getElementById("inventory-container");
        const term = document
          .getElementById("search-input")
          .value.toLowerCase();
        container.innerHTML = "";
        let filtered = inventory.filter((i) => {
          return (
            (i.name.toLowerCase().includes(term) ||
              (i.tag && i.tag.toLowerCase().includes(term)) ||
              (i.supplier && i.supplier.toLowerCase().includes(term))) &&
            (activeTab === "Todas" || i.category === activeTab)
          );
        });
        filtered.sort((a, b) => {
          if (sortMode === "name_asc") return a.name.localeCompare(b.name);
          if (sortMode === "name_desc") return b.name.localeCompare(a.name);
          if (sortMode === "qty_asc") return a.qty - b.qty;
          return b.qty - a.qty;
        });

        if (filtered.length === 0) {
          container.innerHTML = `<div class="py-12 text-center text-text-light flex flex-col items-center"><i class="fas fa-search text-4xl mb-3 text-slate-200"></i><p>Nenhum Item Encontrado</p></div>`;
          return;
        }

        if (viewMode === "grid") {
          let html =
            // Mobile: 2 columns, scales up progressively
            '<div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 3xl:grid-cols-8 gap-3 sm:gap-4 md:gap-6">';
          filtered.forEach((item) => {
            const isCrit = item.qty < item.min,
              pct = Math.min(100, (item.qty / (item.min * 2)) * 100),
              bar = isCrit
                ? "bg-error"
                : item.qty === item.min
                ? "bg-warning"
                : "bg-success";
            const img = item.image
              ? `<img src="${item.image}" loading="lazy" decoding="async" class="card-img">`
              : `<div class="flex flex-col items-center justify-center h-full text-slate-300"><i class="fas fa-image text-2xl sm:text-3xl"></i></div>`;
            html += `<div class="inventory-card bg-white rounded-xl sm:rounded-2xl shadow-card border border-slate-100 hover:shadow-floating transition-all overflow-hidden flex flex-col group relative ${
              isCrit ? "ring-2 ring-error" : ""
            }">
                            <div class="card-img-wrapper h-28 sm:h-44">${img}
                                <div class="absolute inset-0 bg-slate-900/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2 sm:gap-3 backdrop-blur-[2px]">
                                     <button onclick="prepareEdit('${
                                       item.id
                                     }')" class="bg-white text-slate-800 w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition"><i class="fas fa-pen text-xs sm:text-sm"></i></button>
                                     <button onclick="deleteItem('${
                                       item.id
                                     }')" class="hidden sm:flex bg-white text-error w-8 h-8 sm:w-10 sm:h-10 rounded-full items-center justify-center shadow-lg hover:scale-110 transition"><i class="fas fa-trash text-xs sm:text-sm"></i></button>
                                </div>
                                <div class="absolute top-2 right-2 sm:top-3 sm:right-3 bg-white/95 px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-md sm:rounded-lg text-[8px] sm:text-[10px] font-bold shadow-sm text-slate-600">${
                                  item.category
                                }</div>
                                ${
                                  isCrit
                                    ? '<div class="absolute top-2 left-2 sm:top-3 sm:left-3 bg-error text-white px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-md sm:rounded-lg text-[8px] sm:text-[10px] font-bold animate-pulse">Repor</div>'
                                    : ""
                                }
                            </div>
                            <div class="p-2.5 sm:p-4 md:p-5 flex-1 flex flex-col"><div class="mb-1"><h4 class="font-bold text-slate-800 text-xs sm:text-sm md:text-base leading-tight line-clamp-2" title="${
                              item.name
                            }">${
              item.name
            }</h4><p class="text-[10px] sm:text-xs text-slate-400 truncate mt-0.5 sm:mt-1 hidden sm:block"><i class="fas fa-truck mr-1"></i>${
              item.supplier || "N/A"
            }</p></div>
                                <div class="flex flex-wrap items-center gap-1 sm:gap-2 mb-2 sm:mb-4 mt-1 sm:mt-2">${
                                  item.tag
                                    ? `<span class="text-[8px] sm:text-[10px] bg-indigo-50 text-indigo-600 px-1.5 sm:px-2 py-0.5 rounded-md font-bold">#${item.tag}</span>`
                                    : ""
                                }</div>
                                <div class="mt-auto"><div class="flex justify-between items-end mb-0.5 sm:mb-1 text-sm"><span class="text-slate-500 text-[9px] sm:text-xs font-bold uppercase">Estoque</span><span class="text-slate-400 text-[9px] sm:text-xs">Min: ${
                                  item.min
                                }</span></div>
                                    <div class="flex items-center justify-between mb-1.5 sm:mb-2"><span class="text-lg sm:text-xl md:text-2xl font-bold ${
                                      isCrit ? "text-error" : "text-slate-700"
                                    }">${
              item.qty
            }</span><div class="w-1/3 sm:w-1/2 h-1.5 sm:h-2 bg-slate-100 rounded-full overflow-hidden ml-2 sm:ml-3"><div class="h-full ${bar}" style="width: ${pct}%"></div></div></div>
                                    <div class="flex gap-1.5 sm:gap-2 mt-2 sm:mt-3"><button onclick="updateStockDirect('${
                                      item.id
                                    }', -1)" class="flex-1 h-7 sm:h-9 flex items-center justify-center border border-slate-200 rounded-md sm:rounded-lg hover:bg-slate-50 text-slate-500 transition text-xs sm:text-sm"><i class="fas fa-minus"></i></button><button onclick="updateStockDirect('${
              item.id
            }', 1)" class="flex-1 h-7 sm:h-9 flex items-center justify-center bg-primary text-white rounded-md sm:rounded-lg hover:bg-slate-800 shadow-md transition text-xs sm:text-sm"><i class="fas fa-plus"></i></button></div>
                                </div></div></div>`;
          });
          container.innerHTML = html + "</div>";
        } else {
          // List view - Cards on mobile, Table on desktop
          // Mobile: Card layout
          let mobileHtml = '<div class="sm:hidden space-y-3">';
          filtered.forEach((item) => {
            const isCrit = item.qty < item.min;
            const img = item.image
              ? `<img src="${item.image}" loading="lazy" decoding="async" class="w-14 h-14 rounded-lg object-cover">`
              : `<div class="w-14 h-14 bg-slate-100 rounded-lg flex items-center justify-center text-slate-400"><i class="fas fa-box"></i></div>`;
            mobileHtml += `<div class="bg-white rounded-xl shadow-card border border-slate-100 p-3 ${
              isCrit ? "ring-2 ring-error" : ""
            }">
              <div class="flex items-center gap-3">
                ${img}
                <div class="flex-1 min-w-0">
                  <h4 class="font-bold text-slate-800 text-sm truncate">${
                    item.name
                  }</h4>
                  <p class="text-[10px] text-slate-400 mt-0.5">${
                    item.category
                  }</p>
                </div>
                <div class="flex flex-col items-end gap-1">
                  <span class="text-lg font-bold ${
                    isCrit ? "text-error" : "text-slate-700"
                  }">${item.qty}</span>
                  <div class="flex gap-1">
                    <button onclick="updateStockDirect('${
                      item.id
                    }', -1)" class="w-7 h-7 rounded-md bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs flex items-center justify-center">-</button>
                    <button onclick="updateStockDirect('${
                      item.id
                    }', 1)" class="w-7 h-7 rounded-md bg-primary text-white hover:bg-slate-800 text-xs flex items-center justify-center">+</button>
                  </div>
                </div>
              </div>
              <div class="flex justify-end gap-2 mt-2 pt-2 border-t border-slate-100">
                <button onclick="prepareEdit('${
                  item.id
                }')" class="text-xs text-blue-600 font-medium flex items-center gap-1"><i class="fas fa-pen"></i> Editar</button>
              </div>
            </div>`;
          });
          mobileHtml += "</div>";

          // Desktop: Table layout
          let html = `<div class="hidden sm:block bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-text-light font-bold text-xs uppercase"><tr><th class="p-4 w-20"></th><th class="p-4">Item</th><th class="p-4 hidden md:table-cell">Categoria</th><th class="p-4 text-center">Qtd</th><th class="p-4 text-right">Ações</th></tr></thead><tbody class="divide-y divide-slate-50">`;
          filtered.forEach((item) => {
            const isCrit = item.qty < item.min,
              img = item.image
                ? `<img src="${item.image}" loading="lazy" decoding="async" class="w-16 h-16 rounded-lg object-contain bg-white">`
                : `<div class="w-16 h-16 bg-slate-100 rounded-lg flex items-center justify-center text-slate-400"><i class="fas fa-box"></i></div>`;
            html += `<tr class="hover:bg-slate-50 transition"><td class="p-4">${img}</td><td class="p-4"><div class="font-bold text-slate-800 text-sm">${
              item.name
            }</div></td><td class="p-4 hidden md:table-cell"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs">${
              item.category
            }</span></td><td class="p-4 text-center"><div class="flex items-center justify-center gap-2"><button onclick="updateStockDirect('${
              item.id
            }', -1)" class="w-7 h-7 rounded bg-slate-100 hover:bg-slate-200 text-slate-600 text-sm flex items-center justify-center">-</button><span class="font-bold w-8 text-center text-base ${
              isCrit ? "text-error" : "text-slate-700"
            }">${item.qty}</span><button onclick="updateStockDirect('${
              item.id
            }', 1)" class="w-7 h-7 rounded bg-slate-100 hover:bg-slate-200 text-slate-600 text-sm flex items-center justify-center">+</button></div></td><td class="p-4 text-right whitespace-nowrap"><button onclick="prepareEdit('${
              item.id
            }')" class="text-blue-600 p-2"><i class="fas fa-pen"></i></button><button onclick="deleteItem('${
              item.id
            }')" class="text-error p-2"><i class="fas fa-trash"></i></button></td></tr>`;
          });
          container.innerHTML = mobileHtml + html + "</tbody></table></div>";
          // after rendering list mode, adjust the small control buttons for better UX
          try {
            styleInventoryListControls();
          } catch (e) {}
        }
      }

      // Enhance list view controls after render: resize images already handled in template
      function styleInventoryListControls() {
        const container = document.getElementById("inventory-container");
        if (!container) return;
        const table = container.querySelector("table");
        if (!table) return;

        table.querySelectorAll("tbody tr").forEach((tr) => {
          // status column: buttons and qty
          const statusTd = tr.querySelector("td:nth-child(4)");
          if (statusTd) {
            const controls = Array.from(statusTd.querySelectorAll("button"));
            controls.forEach((btn) => {
              const txt = btn.textContent.trim();
              if (txt === "-") {
                btn.className =
                  "w-8 h-8 flex items-center justify-center rounded-md border border-slate-200 text-slate-600 hover:bg-slate-50 transition";
                btn.setAttribute("title", "Diminuir 1");
                btn.setAttribute("aria-label", "Diminuir quantidade");
              } else if (txt === "+") {
                btn.className =
                  "w-8 h-8 flex items-center justify-center rounded-md bg-primary text-white hover:bg-slate-800 transition";
                btn.setAttribute("title", "Adicionar 1");
                btn.setAttribute("aria-label", "Adicionar quantidade");
              }
            });
          }

          // actions column: edit / delete buttons
          const actionsTd = tr.querySelector("td:last-child");
          if (actionsTd) {
            const actionButtons = Array.from(
              actionsTd.querySelectorAll("button")
            );
            const editBtn = actionButtons[0];
            const delBtn = actionButtons[1];
            if (editBtn) {
              editBtn.className =
                "inline-flex items-center justify-center p-2 rounded-md bg-slate-50 hover:bg-slate-100 text-primary mr-2";
              editBtn.setAttribute("title", "Editar");
              editBtn.setAttribute("aria-label", "Editar item");
            }
            if (delBtn) {
              delBtn.className =
                "inline-flex items-center justify-center p-2 rounded-md bg-red-50 hover:bg-red-100 text-error";
              delBtn.setAttribute("title", "Excluir");
              delBtn.setAttribute("aria-label", "Excluir item");
            }
          }
        });
      }

      function renderShopping() {
        const grid = document.getElementById("shopping-grid");
        const empty = document.getElementById("empty-state-shopping");
        if (!grid || !empty) return;
        
        grid.innerHTML = "";

        // Obter valores dos filtros e pesquisa ANTES de repopular dropdowns
        const searchTerm = (
          document.getElementById("shopping-search-input")?.value || ""
        ).toLowerCase();
        const categorySelect = document.getElementById("shopping-filter-category");
        const supplierSelect = document.getElementById("shopping-filter-supplier");
        const statusSelect = document.getElementById("shopping-filter-status");
        
        // Capturar valores ANTES de modificar os selects
        const filterCategory = categorySelect?.value || "";
        const filterSupplier = supplierSelect?.value || "";
        const filterStatus = statusSelect?.value || "all";

        // Popular dropdowns de categoria e fornecedor (preservando valores selecionados)
        let finalCategory = filterCategory;
        let finalSupplier = filterSupplier;
        
        if (categorySelect) {
          const uniqueCategories = [
            ...new Set(
              inventory
                .filter((i) => i.qty < i.min && i.category)
                .map((i) => i.category)
            ),
          ].sort();
          
          // Verificar se a categoria selecionada ainda existe
          if (filterCategory && !uniqueCategories.includes(filterCategory)) {
            finalCategory = "";
          }
          
          categorySelect.innerHTML =
            '<option value="">Todas as Categorias</option>' +
            uniqueCategories
              .map(
                (cat) =>
                  `<option value="${cat}" ${
                    cat === finalCategory ? "selected" : ""
                  }>${cat}</option>`
              )
              .join("");
          
          // Garantir que o valor seja definido corretamente
          categorySelect.value = finalCategory;
        }

        if (supplierSelect) {
          const uniqueSuppliers = [
            ...new Set(
              inventory
                .filter((i) => i.qty < i.min && i.supplier)
                .map((i) => i.supplier)
            ),
          ].sort();
          
          // Verificar se o fornecedor selecionado ainda existe
          if (filterSupplier && !uniqueSuppliers.includes(filterSupplier)) {
            finalSupplier = "";
          }
          
          supplierSelect.innerHTML =
            '<option value="">Todos os Fornecedores</option>' +
            uniqueSuppliers
              .map(
                (sup) =>
                  `<option value="${sup}" ${
                    sup === finalSupplier ? "selected" : ""
                  }>${sup}</option>`
              )
              .join("");
          
          // Garantir que o valor seja definido corretamente
          supplierSelect.value = finalSupplier;
        }

        // Usar os valores finais (já validados)
        const finalStatus = filterStatus;

        // Filtrar itens que precisam compra
        let toBuy = inventory.filter((i) => i.qty < i.min);

        // Aplicar filtro de status
        if (finalStatus === "pending") {
          toBuy = toBuy.filter((i) => !(i.inTransit || false));
        } else if (finalStatus === "inTransit") {
          toBuy = toBuy.filter((i) => i.inTransit === true);
        }

        // Aplicar filtro de categoria
        if (finalCategory) {
          toBuy = toBuy.filter((i) => i.category === finalCategory);
        }

        // Aplicar filtro de fornecedor
        if (finalSupplier) {
          toBuy = toBuy.filter((i) => i.supplier === finalSupplier);
        }

        // Aplicar pesquisa
        if (searchTerm) {
          toBuy = toBuy.filter(
            (i) =>
              i.name.toLowerCase().includes(searchTerm) ||
              (i.category && i.category.toLowerCase().includes(searchTerm)) ||
              (i.supplier && i.supplier.toLowerCase().includes(searchTerm)) ||
              (i.tag && i.tag.toLowerCase().includes(searchTerm))
          );
        }

        // Ordenar A → Z
        toBuy.sort((a, b) =>
          a.name.localeCompare(b.name, "pt-BR", { sensitivity: "base" })
        );

        if (toBuy.length === 0) {
          empty.classList.remove("hidden");
          grid.classList.add("hidden");
          return;
        }
        empty.classList.add("hidden");
        grid.classList.remove("hidden");

        toBuy.forEach((item) => {
          const sug = Math.ceil(item.min * 1.5) - item.qty;
          const hasImage = !!item.image;
          const isInTransit = item.inTransit || false;
          const img = hasImage
            ? `<img src="${item.image}" loading="lazy" decoding="async" class="w-full h-full object-cover">`
            : '<i class="fas fa-shopping-basket text-lg sm:text-xl"></i>';
          const imageClickListener = hasImage
            ? `onclick="openImageModal('${item.image}')"`
            : "";
          const cursorClass = hasImage ? "cursor-pointer" : "";
          
          // Estilo visual para itens em trânsito
          const borderColor = isInTransit ? "bg-blue-500" : "bg-error";
          const transitBadge = isInTransit
            ? '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md bg-blue-50 text-blue-600 text-[10px] font-bold uppercase"><i class="fas fa-truck"></i> Em Trânsito</span>'
            : "";
          
          grid.innerHTML += `<div class="shopping-item bg-white p-3 sm:p-5 rounded-xl shadow-card border border-slate-100 flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:gap-6 hover:shadow-md transition relative overflow-hidden ${isInTransit ? "shopping-item-in-transit" : ""}">
                        <div class="absolute left-0 top-0 bottom-0 w-1 ${borderColor}"></div>
                        <div class="flex items-center gap-3 sm:gap-4">
                          <div ${imageClickListener} class="w-12 h-12 sm:w-16 sm:h-16 rounded-xl bg-slate-50 text-slate-400 flex items-center justify-center shrink-0 border border-slate-100 overflow-hidden ${cursorClass}">${img}</div>
                          <div class="flex-1 min-w-0 sm:hidden">
                            <h4 class="font-bold text-slate-800 text-sm truncate">${
                              item.name
                            }</h4>
                            <div class="text-[10px] text-text-light mt-0.5 flex items-center gap-2">
                              <span>Atual: <span class="font-bold text-error">${
                                item.qty
                              }</span> / Mín: ${item.min}</span>
                              ${transitBadge}
                            </div>
                          </div>
                        </div>
                        <div class="hidden sm:flex flex-1 min-w-0">
                          <div>
                            <div class="flex items-center gap-2 mb-1">
                              <h4 class="font-bold text-slate-800 text-lg">${
                                item.name
                              }</h4>
                              ${transitBadge}
                            </div>
                            <div class="text-xs text-text-light mt-1">Fornecedor: ${
                              item.supplier || "-"
                            } • Atual: <span class="font-bold text-error">${
            item.qty
          }</span> / Mín: ${item.min}</div>
                          </div>
                        </div>
                        <div class="flex items-center gap-3 sm:gap-4 justify-between bg-slate-50 p-2.5 sm:p-3 rounded-xl sm:bg-transparent sm:p-0">
                          <div class="text-left sm:text-right">
                            <div class="text-[9px] sm:text-[10px] uppercase text-slate-400 font-bold tracking-wider">Sugestão</div>
                            <div class="text-lg sm:text-xl font-bold text-primary">+${sug}</div>
                          </div>
                          <div class="flex items-center gap-2">
                            <button onclick="toggleInTransit('${
                              item.id
                            }')" class="no-print ${isInTransit ? "bg-blue-500 hover:bg-blue-600 text-white" : "bg-slate-200 hover:bg-slate-300 text-slate-600"} px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl shadow-sm transition text-xs sm:text-sm font-bold flex items-center gap-1.5 sm:gap-2" title="${isInTransit ? "Remover de trânsito" : "Marcar como em trânsito"}">
                              <i class="fas fa-${isInTransit ? "check" : "truck"}"></i> <span class="hidden sm:inline">${isInTransit ? "Em Trânsito" : "Trânsito"}</span>
                            </button>
                            <button onclick="openReceiveModal('${
                              item.id
                            }', ${sug})" class="bg-success text-white px-3 sm:px-5 py-2 sm:py-2.5 rounded-xl shadow-lg hover:bg-emerald-600 transition text-xs sm:text-sm font-bold flex items-center gap-1.5 sm:gap-2">
                              <i class="fas fa-check"></i> <span>Receber</span>
                            </button>
                          </div>
                        </div>
                      </div>`;
        });
      }

      function renderHistory(filter = "all") {
        const tbody = document.getElementById("history-table-body"),
          dashTable = document.getElementById("dash-recent-table"),
          mobileCards = document.getElementById("history-cards-mobile"),
          emptyEl = document.getElementById("empty-history");

        // Desktop table HTML
        const tableHtml = historyLog
          .map((log) => {
            const d = new Date(log.date),
              isPos = log.change > 0;
            return `<tr class="hover:bg-slate-50"><td class="p-4 whitespace-nowrap text-slate-500 font-mono text-xs">${d.toLocaleDateString(
              "pt-BR"
            )} ${d.toLocaleTimeString("pt-BR", {
              hour: "2-digit",
              minute: "2-digit",
            })}</td><td class="p-4 font-bold text-slate-700 text-sm">${
              log.itemName
            }</td><td class="p-4 text-center"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${
              isPos
                ? "bg-emerald-50 text-success"
                : "bg-orange-50 text-orange-600"
            }">${
              log.action
            }</span></td><td class="p-4 text-xs text-slate-500 hidden md:table-cell">${
              log.details || "-"
            }</td><td class="p-4 text-right font-mono font-bold text-sm ${
              isPos ? "text-success" : "text-error"
            }">${isPos ? "+" : ""}${log.change}</td></tr>`;
          })
          .join("");

        // Mobile cards HTML
        const cardsHtml = historyLog
          .map((log) => {
            const d = new Date(log.date),
              isPos = log.change > 0;
            return `<div class="bg-white rounded-xl shadow-card border border-slate-100 p-3">
              <div class="flex items-start justify-between gap-2">
                <div class="flex-1 min-w-0">
                  <p class="font-bold text-slate-800 text-sm truncate">${
                    log.itemName
                  }</p>
                  <p class="text-[10px] text-slate-400 mt-0.5">${d.toLocaleDateString(
                    "pt-BR"
                  )} às ${d.toLocaleTimeString("pt-BR", {
              hour: "2-digit",
              minute: "2-digit",
            })}</p>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase ${
                    isPos
                      ? "bg-emerald-50 text-success"
                      : "bg-orange-50 text-orange-600"
                  }">${log.action}</span>
                  <span class="font-mono font-bold text-sm ${
                    isPos ? "text-success" : "text-error"
                  }">${isPos ? "+" : ""}${log.change}</span>
                </div>
              </div>
            </div>`;
          })
          .join("");

        if (tbody)
          tbody.innerHTML =
            tableHtml ||
            '<tr><td colspan="5" class="p-8 text-center text-slate-400">Vazio</td></tr>';

        if (mobileCards) mobileCards.innerHTML = cardsHtml || "";

        // Show/hide empty state
        if (emptyEl) {
          if (historyLog.length === 0) {
            emptyEl.classList.remove("hidden");
          } else {
            emptyEl.classList.add("hidden");
          }
        }
        if (dashTable) {
          dashTable.innerHTML =
            historyLog
              .slice(0, 8)
              .map((log) => {
                const isPos = log.change > 0;
                const time = new Date(log.date).toLocaleTimeString("pt-BR", {
                  hour: "2-digit",
                  minute: "2-digit",
                });
                return `<tr class="hover:bg-slate-50 transition">
                  <td class="p-4 font-medium text-slate-700 text-sm">
                    <span class="truncate block">${log.itemName}</span>
                  </td>
                  <td class="p-4 text-center"><span class="text-[10px] font-bold uppercase px-2 py-1 rounded ${
                    isPos
                      ? "bg-emerald-50 text-emerald-600"
                      : "bg-orange-50 text-orange-600"
                  }">${log.action}</span></td>
                  <td class="p-4 text-right font-bold text-sm ${
                    isPos ? "text-emerald-600" : "text-orange-600"
                  }">${isPos ? "+" : ""}${log.change}</td>
                  <td class="p-4 text-right text-xs text-slate-400">${time}</td>
               </tr>`;
              })
              .join("") ||
            '<tr><td colspan="4" class="p-6 text-center text-slate-400 text-sm">Nenhuma movimentação recente.</td></tr>';
        }

        // Dashboard mobile cards
        const dashCards = document.getElementById("dash-recent-cards");
        if (dashCards) {
          dashCards.innerHTML =
            historyLog
              .slice(0, 8)
              .map((log) => {
                const isPos = log.change > 0;
                const time = new Date(log.date).toLocaleTimeString("pt-BR", {
                  hour: "2-digit",
                  minute: "2-digit",
                });
                return `<div class="bg-slate-50 rounded-lg p-2.5 flex items-center justify-between gap-2">
              <div class="flex-1 min-w-0">
                <p class="font-medium text-slate-700 text-xs truncate">${
                  log.itemName
                }</p>
                <p class="text-[10px] text-slate-400">${time}</p>
              </div>
              <div class="flex items-center gap-1.5 flex-shrink-0">
                <span class="text-[9px] font-bold uppercase px-1.5 py-0.5 rounded ${
                  isPos
                    ? "bg-emerald-100 text-emerald-600"
                    : "bg-orange-100 text-orange-600"
                }">${log.action}</span>
                <span class="font-mono font-bold text-xs ${
                  isPos ? "text-emerald-600" : "text-orange-600"
                }">${isPos ? "+" : ""}${log.change}</span>
              </div>
            </div>`;
              })
              .join("") ||
            '<p class="text-center text-slate-400 text-xs py-4">Nenhuma movimentação recente.</p>';
        }
      }

      function updateDashboard() {
        const critical = inventory.filter((i) => i.qty < i.min);

        // Update Date
        const dateEl = document.getElementById("dash-date-display");
        if (dateEl)
          dateEl.innerText = new Date().toLocaleDateString("pt-BR", {
            weekday: "long",
            day: "numeric",
            month: "long",
          });

        // Metrics
        const totalEl = document.getElementById("dash-metric-total");
        if (totalEl) totalEl.innerText = inventory.length;

        const critMetricEl = document.getElementById("dash-metric-critical");
        if (critMetricEl) critMetricEl.innerText = critical.length;

        const critBadgeEl = document.getElementById("dash-critical-badge");
        if (critBadgeEl) critBadgeEl.innerText = critical.length;

        // Critical List
        const listEl = document.getElementById("dash-critical-list");
        if (listEl) {
          listEl.innerHTML =
            critical.length === 0
              ? '<div class="text-center py-6 sm:py-8 text-slate-400 text-xs sm:text-sm bg-slate-50 rounded-xl border border-slate-100 border-dashed">Estoque saudável!</div>'
              : critical
                  .map(
                    (i) =>
                      `<div class="flex justify-between items-center p-2.5 sm:p-3 rounded-xl border border-slate-100 hover:bg-slate-50 transition cursor-pointer group" onclick="openReceiveModal('${
                        i.id
                      }', ${Math.ceil(i.min * 1.5) - i.qty})">
                      <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                          <div class="w-9 h-9 sm:w-10 sm:h-10 rounded-lg bg-red-50 text-error flex items-center justify-center font-bold text-xs sm:text-sm border border-red-100 group-hover:bg-red-100 transition flex-shrink-0">${
                            i.qty
                          }</div>
                          <div class="min-w-0 flex-1">
                              <p class="text-xs sm:text-sm font-bold text-slate-700 truncate">${
                                i.name
                              }</p>
                              <p class="text-[9px] sm:text-[10px] text-slate-400">Mínimo: ${
                                i.min
                              }</p>
                          </div>
                      </div>
                      <i class="fas fa-chevron-right text-xs text-slate-300 group-hover:text-brand transition ml-2 flex-shrink-0"></i>
                  </div>`
                  )
                  .join("");
        }

        updateGlobalCharts();

        // Entradas / Saídas do dia (soma de alterações no histórico para hoje)
        try {
          const today = new Date();
          const isSameDay = (d) => {
            const dd = new Date(d);
            return (
              dd.getFullYear() === today.getFullYear() &&
              dd.getMonth() === today.getMonth() &&
              dd.getDate() === today.getDate()
            );
          };
          const entriesToday = historyLog
            .filter((h) => isSameDay(h.date) && h.change > 0)
            .reduce((s, h) => s + Number(h.change || 0), 0);
          const exitsToday = historyLog
            .filter((h) => isSameDay(h.date) && h.change < 0)
            .reduce((s, h) => s + Math.abs(Number(h.change || 0)), 0);

          const entEl = document.getElementById("dash-metric-entries");
          const exitEl = document.getElementById("dash-metric-exits");
          if (entEl) entEl.innerText = entriesToday;
          if (exitEl) exitEl.innerText = exitsToday;
        } catch (e) {}
      }

      function updateGlobalCharts() {
        const ctx = document.getElementById("categoryChart");
        if (!ctx) return;
        const counts = {};
        inventory.forEach(
          (i) => (counts[i.category] = (counts[i.category] || 0) + 1)
        );
        if (categoryChartInstance) categoryChartInstance.destroy();
        categoryChartInstance = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: Object.keys(counts),
            datasets: [
              {
                data: Object.values(counts),
                backgroundColor: [
                  "#3b82f6",
                  "#10b981",
                  "#f59e0b",
                  "#ef4444",
                  "#8b5cf6",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%",
            plugins: {
              legend: { position: "right", labels: { boxWidth: 10 } },
            },
          },
        });
      }

      function dashQuickSearch(val) {
        const container = document.getElementById("dash-quick-results");
        const def = document.getElementById("dash-quick-default");
        const term = val.toLowerCase().trim();

        if (!term) {
          container.classList.add("hidden");
          def.classList.remove("hidden");
          return;
        }

        def.classList.add("hidden");
        container.classList.remove("hidden");
        // accessibility: mark input expanded
        const inputEl = document.getElementById("dash-quick-search");
        if (inputEl) inputEl.setAttribute("aria-expanded", "true");

        const matches = inventory
          .filter(
            (i) =>
              i.name.toLowerCase().includes(term) ||
              (i.tag && i.tag.toLowerCase().includes(term)) ||
              (i.category && i.category.toLowerCase().includes(term))
          )
          .slice(0, 8);

        if (matches.length === 0) {
          container.innerHTML = `
            <div class="text-center py-6 px-4">
              <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-slate-100 flex items-center justify-center">
                <i class="fas fa-search text-slate-300 text-lg"></i>
              </div>
              <p class="text-sm font-medium text-slate-500">Nenhum Item Encontrado</p>
              
            </div>`;
        } else {
          container.innerHTML =
            `
            <div class="px-3 py-2 bg-slate-50 border-b border-slate-100">
              <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${
                matches.length
              } resultado${matches.length > 1 ? "s" : ""}</span>
            </div>` +
            matches
              .map((i) => {
                const isCrit = i.qty < i.min;
                const img = i.image
                  ? `<img src="${i.image}" class="w-11 h-11 rounded-lg object-cover border border-slate-100">`
                  : `<div class="w-11 h-11 rounded-lg bg-gradient-to-br from-slate-100 to-slate-50 flex items-center justify-center text-slate-400 border border-slate-100"><i class="fas fa-box"></i></div>`;
                return `<div data-quick-id="${i.id}" role="option" tabindex="0" onclick="openQuickItem('${i.id}')" class="flex items-center gap-3 px-3 py-2.5 hover:bg-blue-50 cursor-pointer border-b border-slate-50 last:border-0 transition-colors group">
                ${img}
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-semibold text-slate-800 truncate group-hover:text-blue-700">${i.name}</div>
                    <div class="text-[10px] text-slate-500 mt-0.5">
                      ${i.category} · ${i.qty} un.
                    </div>
                </div>
                <div class="w-7 h-7 rounded-full bg-slate-100 group-hover:bg-blue-100 flex items-center justify-center transition-colors">
                  <i class="fas fa-pen text-[10px] text-slate-400 group-hover:text-blue-600"></i>
                </div>
            </div>`;
              })
              .join("");

          // enable keyboard navigation for results
          setTimeout(() => {
            const inputEl2 = document.getElementById("dash-quick-search");
            const opts = Array.from(
              container.querySelectorAll('[role="option"]')
            );
            // if there are options, ensure input aria-expanded and keyboard events
            if (inputEl2) {
              inputEl2.setAttribute(
                "aria-expanded",
                opts.length > 0 ? "true" : "false"
              );
              inputEl2.onkeydown = function (e) {
                if (e.key === "ArrowDown") {
                  e.preventDefault();
                  if (opts[0]) opts[0].focus();
                } else if (e.key === "Escape") {
                  container.classList.add("hidden");
                  this.setAttribute("aria-expanded", "false");
                  def.classList.remove("hidden");
                }
              };
            }

            opts.forEach((opt, idx) => {
              opt.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                  e.preventDefault();
                  const id = opt.getAttribute("data-quick-id");
                  if (id) openQuickItem(id);
                } else if (e.key === "ArrowDown") {
                  e.preventDefault();
                  const next = opts[idx + 1];
                  if (next) next.focus();
                } else if (e.key === "ArrowUp") {
                  e.preventDefault();
                  if (idx === 0) {
                    const iel = document.getElementById("dash-quick-search");
                    if (iel) iel.focus();
                  } else {
                    const prev = opts[idx - 1];
                    if (prev) prev.focus();
                  }
                } else if (e.key === "Escape") {
                  e.preventDefault();
                  const iel = document.getElementById("dash-quick-search");
                  if (iel) {
                    iel.focus();
                    iel.setAttribute("aria-expanded", "false");
                  }
                  container.classList.add("hidden");
                  def.classList.remove("hidden");
                }
              });
            });
          }, 10);
        }
      }

      function openQuickItem(id) {
        // Limpar busca e fechar dropdown
        const searchEl = document.getElementById("dash-quick-search");
        if (searchEl) {
          searchEl.value = "";
          searchEl.setAttribute("aria-expanded", "false");
        }
        document.getElementById("dash-quick-results").classList.add("hidden");
        document
          .getElementById("dash-quick-default")
          .classList.remove("hidden");

        // Abrir modal de edição do item
        prepareEdit(id);
      }

      // Função de impressão da lista de compras
      function printShoppingList() {
        // Atualizar subtítulo com data
        const subtitle = document.querySelector("#view-shopping .print-subtitle");
        if (subtitle) {
          const now = new Date();
          subtitle.textContent = `Gerado em ${now.toLocaleDateString(
            "pt-BR"
          )} às ${now.toLocaleTimeString("pt-BR", {
            hour: "2-digit",
            minute: "2-digit",
          })}`;
          subtitle.classList.remove("hidden");
        }

        // Obter todos os itens atualmente visíveis no grid (já filtrados)
        const grid = document.getElementById("shopping-grid");
        const allItems = grid ? Array.from(grid.querySelectorAll(".shopping-item")) : [];
        const itemsToHide = [];
        
        // Ocultar itens em trânsito e garantir que apenas os visíveis sejam impressos
        allItems.forEach((item) => {
          // Ocultar itens em trânsito da impressão
          if (item.classList.contains("shopping-item-in-transit")) {
            if (!item.classList.contains("print-hidden")) {
              item.classList.add("print-hidden");
              itemsToHide.push(item);
            }
          }
        });

        // Adicionar classe CSS para ocultar itens marcados na impressão
        if (!document.getElementById("print-shopping-style")) {
          const style = document.createElement("style");
          style.id = "print-shopping-style";
          style.textContent = `
            @media print {
              .print-hidden {
                display: none !important;
              }
            }
          `;
          document.head.appendChild(style);
        }

        // Imprimir
        window.print();

        // Restaurar itens após impressão
        setTimeout(() => {
          itemsToHide.forEach((item) => {
            item.classList.remove("print-hidden");
          });
          // Esconder subtítulo após impressão
          if (subtitle) subtitle.classList.add("hidden");
        }, 1000);
      }

      // Fechar dropdown ao clicar fora
      document.addEventListener("click", function (e) {
        const searchInput = document.getElementById("dash-quick-search");
        const resultsContainer = document.getElementById("dash-quick-results");
        if (searchInput && resultsContainer) {
          if (
            !searchInput.contains(e.target) &&
            !resultsContainer.contains(e.target)
          ) {
            resultsContainer.classList.add("hidden");
            // mark input as collapsed for screen readers
            try {
              searchInput.setAttribute("aria-expanded", "false");
            } catch (e) {}
            document
              .getElementById("dash-quick-default")
              .classList.remove("hidden");
          }
        }
      });

      // --- Modals & Utils ---
      function openImageModal(src) {
        if (!src) return;
        document.getElementById("modal-image-src").src = src;
        const modal = document.getElementById("modal-image");
        modal.classList.remove("hidden");
        setTimeout(() => {
          modal.classList.remove("opacity-0");
          modal.children[0].classList.remove("scale-95");
        }, 10);
      }
      function closeImageModal() {
        const modal = document.getElementById("modal-image");
        modal.classList.add("opacity-0");
        modal.children[0].classList.add("scale-95");
        setTimeout(() => {
          modal.classList.add("hidden");
          document.getElementById("modal-image-src").src = "";
        }, 300);
      }
      function openModal() {
        document.getElementById("modal-form").classList.remove("hidden");
        setTimeout(() => {
          document
            .getElementById("modal-form")
            .children[0].classList.remove("scale-95");
          document.getElementById("modal-form").classList.remove("opacity-0");
        }, 10);
        if (!document.getElementById("editItemId").value) {
          document.getElementById("item-form").reset();
          removeImage({ stopPropagation: () => {} });
          populateCategorySelect();
          // esconder destaque do nome quando for novo item
          const formNameContainer = document.getElementById(
            "form-item-name-container"
          );
          if (formNameContainer) formNameContainer.classList.add("hidden");
        }
      }
      function closeModal() {
        document.getElementById("modal-form").classList.add("opacity-0");
        setTimeout(() => {
          document.getElementById("modal-form").classList.add("hidden");
          document.getElementById("editItemId").value = "";
          const formNameContainer = document.getElementById(
            "form-item-name-container"
          );
          if (formNameContainer) formNameContainer.classList.add("hidden");
        }, 200);
      }
      function openReceiveModal(id, sug) {
        const item = inventory.find((i) => i.id === id);
        if (!item) return;
        document.getElementById("receiveItemId").value = id;
        document.getElementById("receive-item-name").innerText = item.name;
        // preenche a quantidade sugerida no campo (visível apenas como valor)
        document.getElementById("receiveQty").value = sug;
        // antes havia um campo de custo aqui — removido por simplificação
        document.getElementById("modal-receive").classList.remove("hidden");
        setTimeout(
          () =>
            document
              .getElementById("modal-receive")
              .classList.remove("opacity-0"),
          10
        );
        setTimeout(() => document.getElementById("receiveQty").focus(), 100);
      }
      function closeReceiveModal() {
        document.getElementById("modal-receive").classList.add("opacity-0");
        setTimeout(
          () =>
            document.getElementById("modal-receive").classList.add("hidden"),
          200
        );
      }
      function openCategoryModal() {
        document.getElementById("modal-category").classList.remove("hidden");
        setTimeout(
          () =>
            document
              .getElementById("modal-category")
              .classList.remove("opacity-0"),
          10
        );
      }
      function closeCategoryModal() {
        document.getElementById("modal-category").classList.add("opacity-0");
        setTimeout(
          () =>
            document.getElementById("modal-category").classList.add("hidden"),
          200
        );
      }
      function prepareEdit(id) {
        const item = inventory.find((i) => i.id === id);
        if (!item) return;
        populateCategorySelect();
        document.getElementById("modal-title").innerText = "Editar";
        document.getElementById("editItemId").value = id;
        document.getElementById("inpName").value = item.name;
        document.getElementById("inpCategory").value = item.category;
        document.getElementById("inpTag").value = item.tag || "";
        document.getElementById("inpSupplier").value = item.supplier || "";
        document.getElementById("inpQty").value = item.qty;
        document.getElementById("inpMin").value = item.min;
        if (item.image) {
          document.getElementById("imgBase64").value = item.image;
          document.getElementById("img-preview").src = item.image;
          document.getElementById("img-preview").classList.remove("hidden");
          document.getElementById("upload-placeholder").classList.add("hidden");
        } else removeImage({ stopPropagation: () => {} });
        // mostrar destaque do nome no modal de edição
        const formNameEl = document.getElementById("form-item-name");
        const formNameContainer = document.getElementById(
          "form-item-name-container"
        );
        if (formNameEl) formNameEl.innerText = item.name;
        if (formNameContainer) formNameContainer.classList.remove("hidden");
        openModal();
      }
      function populateCategorySelect() {
        document.getElementById("inpCategory").innerHTML = categories
          .map((c) => `<option value="${c}">${c}</option>`)
          .join("");
      }
      function renderCategoryTabs() {
        document.getElementById("category-tabs-container").innerHTML =
          `<button onclick="setActiveTab('Todas')" class="tab-btn px-4 sm:px-5 py-2 sm:py-2.5 text-xs sm:text-sm font-medium whitespace-nowrap ${
            activeTab === "Todas" ? "active" : ""
          }">Todas</button>` +
          categories
            .map(
              (c) =>
                `<button onclick="setActiveTab('${c}')" class="tab-btn px-4 sm:px-5 py-2 sm:py-2.5 text-xs sm:text-sm font-medium whitespace-nowrap ${
                  activeTab === c ? "active" : ""
                }">${c}</button>`
            )
            .join("");
      }
      function renderCategoryTable() {
        const tbody = document.getElementById("category-table-body");
        if (tbody)
          tbody.innerHTML = categories
            .map(
              (c) =>
                `<tr class="hover:bg-slate-50"><td class="p-3 sm:p-4 font-medium text-sm">${c}</td><td class="p-3 sm:p-4 text-center text-slate-500 text-sm">${
                  inventory.filter((i) => i.category === c).length
                }</td><td class="p-3 sm:p-4 text-right"><button onclick="deleteCategory('${c}')" class="text-red-500 p-1"><i class="fas fa-trash"></i></button></td></tr>`
            )
            .join("");
      }
      function setActiveTab(t) {
        activeTab = t;
        renderCategoryTabs();
        renderInventory();
      }
      function changeSort(m) {
        sortMode = m;
        renderInventory();
      }
      function toggleViewMode(m) {
        viewMode = m;
        localStorage.setItem("dd_view_mode", m);
        renderInventory();
      }
      function showToast(m, t = "info") {
        const el = document.createElement("div");
        el.className = `toast border-l-4 ${
          t === "success" ? "border-green-500" : "border-blue-900"
        }`;
        el.innerHTML = `<span class="font-bold text-slate-700">${m}</span>`;
        document.getElementById("toast-container").appendChild(el);
        requestAnimationFrame(() => el.classList.add("show"));
        setTimeout(() => {
          el.classList.remove("show");
          setTimeout(() => el.remove(), 400);
        }, 3000);
      }
      function processImage(input) {
        // accepts an <input> element or a File object
        let file = null;
        if (input instanceof File) file = input;
        else if (input && input.files && input.files[0]) file = input.files[0];
        if (!file) return;

        const MAX_SIZE = 5 * 1024 * 1024; // 5MB
        if (!file.type.startsWith("image/"))
          return showToast("Formato não suportado", "default");
        if (file.size > MAX_SIZE)
          return showToast("Arquivo muito grande — limite 5MB", "default");

        const area = document.getElementById("upload-area");
        const processing = document.getElementById("upload-processing");
        const info = document.getElementById("upload-info");
        const placeholder = document.getElementById("upload-placeholder");
        const preview = document.getElementById("img-preview");
        const removeBtn = document.getElementById("btn-remove-img");

        if (processing) processing.classList.remove("hidden");

        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = function () {
            // resize image client-side for consistent sizes (max width)
            const c = document.createElement("canvas"),
              MAX = 1000;
            const scale = img.width > MAX ? MAX / img.width : 1;
            c.width = img.width * scale;
            c.height = img.height * scale;
            const ctx = c.getContext("2d");
            ctx.drawImage(img, 0, 0, c.width, c.height);
            const d = c.toDataURL("image/jpeg", 0.8);

            // set hidden field and preview
            document.getElementById("imgBase64").value = d;
            preview.src = d;
            preview.classList.remove("hidden");
            preview.setAttribute("alt", file.name);
            if (placeholder) placeholder.classList.add("hidden");
            if (info)
              info.innerText = `${file.name} — ${Math.round(
                file.size / 1024
              )} KB`;
            if (info) info.classList.remove("hidden");
            if (removeBtn) removeBtn.classList.remove("hidden");
            if (processing) processing.classList.add("hidden");
          };
        };
        reader.readAsDataURL(file);
      }
      function removeImage(e) {
        if (e && e.stopPropagation) e.stopPropagation();
        const fileEl = document.getElementById("fileInput");
        const preview = document.getElementById("img-preview");
        const info = document.getElementById("upload-info");
        const placeholder = document.getElementById("upload-placeholder");
        const removeBtn = document.getElementById("btn-remove-img");
        if (fileEl) fileEl.value = "";
        document.getElementById("imgBase64").value = "";
        if (preview) preview.classList.add("hidden");
        if (info) info.classList.add("hidden");
        if (placeholder) placeholder.classList.remove("hidden");
        if (removeBtn) removeBtn.classList.add("hidden");
      }
      function toggleMobileSidebar() {
        const sidebar = document.getElementById("main-sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        sidebar.classList.toggle("mobile-open");
        overlay.classList.toggle("active");
      }

      function switchView(v) {
        document
          .querySelectorAll(".view-section")
          .forEach((e) => e.classList.add("hidden"));
        document.getElementById(`view-${v}`).classList.remove("hidden");
        document
          .querySelectorAll(".nav-link")
          .forEach((e) => e.classList.remove("active"));
        document.getElementById(`nav-${v}`).classList.add("active");

        // Fechar sidebar mobile ao trocar de view
        if (window.innerWidth < 768) {
          const sidebar = document.getElementById("main-sidebar");
          const overlay = document.getElementById("sidebar-overlay");
          sidebar.classList.remove("mobile-open");
          overlay.classList.remove("active");
        }

        if (v === "inventory") {
          renderCategoryTabs();
          renderInventory();
        }
        if (v === "settings") renderCategoryTable();
        if (v === "shopping") renderShopping();
        if (v === "history") renderHistory();
        updateGlobalUI();
      }

      // Floating back-to-top button setup
      function setupScrollTop() {
        const container = document.getElementById("content-area");
        const btn = document.getElementById("btn-scroll-top");
        if (!container || !btn) return;

        // helper show/hide with transition
        const show = () => {
          btn.classList.remove("hidden");
          // allow the DOM to apply before removing opacity for transition
          setTimeout(() => {
            btn.classList.remove("opacity-0", "pointer-events-none");
            btn.classList.add("opacity-100");
          }, 10);
        };
        const hide = () => {
          btn.classList.remove("opacity-100");
          btn.classList.add("opacity-0", "pointer-events-none");
          setTimeout(() => btn.classList.add("hidden"), 300);
        };

        // initial state
        btn.classList.add("hidden", "opacity-0", "pointer-events-none");

        container.addEventListener("scroll", () => {
          if (container.scrollTop > 300) show();
          else hide();
        });

        // also support clicking the button to scroll up
        btn.addEventListener("click", () => {
          container.scrollTo({ top: 0, behavior: "smooth" });
        });
      }
      // Setup drag-and-drop + keyboard accessibility for image upload area
      function setupImageUploadUI() {
        const area = document.getElementById("upload-area");
        const input = document.getElementById("fileInput");
        if (!area || !input) return;

        const highlight = () =>
          area.classList.add("ring-2", "ring-brand", "border-brand");
        const unhighlight = () =>
          area.classList.remove("ring-2", "ring-brand", "border-brand");

        area.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "copy";
          highlight();
        });
        area.addEventListener("dragleave", (e) => {
          e.preventDefault();
          unhighlight();
        });
        area.addEventListener("drop", (e) => {
          e.preventDefault();
          unhighlight();
          const file = e.dataTransfer.files && e.dataTransfer.files[0];
          if (file) processImage(file);
        });

        // Make sure keyboard users can focus and trigger file select
        area.setAttribute("tabindex", "0");
        area.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            input.click();
          }
        });
      }
      function updateGlobalUI() {
        const c = inventory.filter((i) => i.qty < i.min).length;
        document.getElementById("badge-count").innerText = c;
        c > 0
          ? document
              .getElementById("badge-count")
              .classList.remove("hidden", "scale-0")
          : document
              .getElementById("badge-count")
              .classList.add("hidden", "scale-0");
        document.getElementById("badge-count").classList.add("scale-100");
        if (
          !document
            .getElementById("view-dashboard")
            .classList.contains("hidden")
        )
          updateDashboard();
      }

      initApp();
    </script>
  </body>
</html>
