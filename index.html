<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Door & Design - Gestão de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Configuração Visual -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#0f172a",
              brand: "#f97316",
              "brand-hover": "#ea580c",
              background: "#f8fafc",
              success: "#10b981",
              error: "#ef4444",
              text: "#334155",
              "text-light": "#64748b",
            },
            boxShadow: {
              card: "0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)",
              floating:
                "0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",
            },
          },
        },
      };
    </script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
        color: #334155;
      }

      .fade-in {
        animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Scrollbar Personalizada */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      /* Navegação */
      .nav-link.active {
        background-color: #f1f5f9;
        color: #0f172a;
        font-weight: 600;
        position: relative;
      }
      .nav-link.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: #f97316;
        border-radius: 0 4px 4px 0;
      }

      .tab-btn {
        border-bottom: 2px solid transparent;
        transition: all 0.3s;
        color: #64748b;
      }
      .tab-btn.active {
        border-bottom-color: #f97316;
        color: #0f172a;
        font-weight: 600;
      }

      /* Imagens */
      .card-img-wrapper {
        height: 180px;
        background-color: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
      }
      .card-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
      }
      .inventory-card:hover .card-img {
        transform: scale(1.08);
      }

      /* Toasts */
      #toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }
      @media (max-width: 640px) {
        #toast-container {
          bottom: 12px;
          right: 12px;
          left: 12px;
        }
      }
      .toast {
        pointer-events: auto;
        background: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #0f172a;
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        transform: translateX(120%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        font-size: 14px;
      }
      @media (max-width: 640px) {
        .toast {
          min-width: auto;
          padding: 12px 16px;
          font-size: 13px;
        }
      }
      .toast.show {
        transform: translateX(0);
      }

      /* Mobile Sidebar Overlay */
      #sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 15;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      #sidebar-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      @media (min-width: 768px) {
        #sidebar-overlay {
          display: none;
        }
      }

      /* Sidebar Mobile */
      aside {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      @media (max-width: 767px) {
        aside {
          position: fixed;
          top: 0;
          left: 0;
          bottom: 0;
          transform: translateX(-100%);
          z-index: 20;
          width: 280px;
          max-width: 85vw;
        }
        aside.mobile-open {
          transform: translateX(0);
        }
      }
    </style>
  </head>
  <body
    class="h-screen flex flex-col md:flex-row overflow-hidden bg-background"
  >
    <!-- Loading Overlay -->
    <div
      id="loading-screen"
      class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col transition-opacity duration-500"
    >
      <div
        class="w-12 h-12 border-4 border-brand border-t-transparent rounded-full animate-spin mb-4"
      ></div>
      <p class="text-sm font-bold text-primary animate-pulse">
        Conectando ao Banco de Dados...
      </p>
    </div>

    <div id="toast-container"></div>
    <div id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <!-- Sidebar -->
    <aside
      id="main-sidebar"
      class="w-full md:w-72 bg-white flex flex-col shadow-xl z-20 shrink-0 border-r border-slate-100"
    >
      <div
        class="h-24 flex items-center justify-center border-b border-slate-100 bg-white relative overflow-hidden"
      >
        <div
          class="absolute -top-10 -left-10 w-24 h-24 bg-orange-50 rounded-full blur-2xl opacity-50"
        ></div>
        <div class="flex items-center gap-3 relative z-10">
          <div
            class="w-11 h-11 bg-primary rounded-xl flex items-center justify-center text-white shadow-xl shadow-slate-200"
          >
            <i class="fas fa-layer-group text-xl text-brand"></i>
          </div>
          <div class="flex flex-col">
            <h1
              class="font-extrabold text-xl leading-none text-primary tracking-tight"
            >
              DOOR<span class="text-brand">&</span>DESIGN
            </h1>
            <span
              class="text-[9px] uppercase font-bold text-slate-400 tracking-[0.2em] mt-1 ml-0.5"
              >Online • Team</span
            >
          </div>
        </div>
      </div>

      <nav class="flex-1 py-6 space-y-1 overflow-y-auto px-4">
        <button
          onclick="switchView('dashboard')"
          id="nav-dashboard"
          class="nav-link active w-full flex items-center gap-4 px-4 py-3.5 rounded-lg transition-all text-text-light hover:bg-slate-50 hover:text-primary"
        >
          <i class="fas fa-chart-pie w-5 text-center"></i>
          <span class="text-sm font-medium">Visão Geral</span>
        </button>
        <button
          onclick="switchView('inventory')"
          id="nav-inventory"
          class="nav-link w-full flex items-center gap-4 px-4 py-3.5 rounded-lg transition-all text-text-light hover:bg-slate-50 hover:text-primary"
        >
          <i class="fas fa-boxes w-5 text-center"></i>
          <span class="text-sm font-medium">Estoque</span>
        </button>
        <button
          onclick="switchView('shopping')"
          id="nav-shopping"
          class="nav-link w-full flex items-center gap-4 px-4 py-3.5 rounded-lg transition-all text-text-light hover:bg-slate-50 hover:text-primary group"
        >
          <div class="relative w-5 text-center">
            <i
              class="fas fa-shopping-cart group-hover:text-brand transition-colors"
            ></i>
            <span
              id="badge-count"
              class="absolute -top-2 -right-2 bg-error text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full shadow-sm hidden scale-0 transition-transform duration-300"
              >0</span
            >
          </div>
          <span class="text-sm font-medium">Compras</span>
        </button>
        <button
          onclick="switchView('history')"
          id="nav-history"
          class="nav-link w-full flex items-center gap-4 px-4 py-3.5 rounded-lg transition-all text-text-light hover:bg-slate-50 hover:text-primary"
        >
          <i class="fas fa-history w-5 text-center"></i>
          <span class="text-sm font-medium">Histórico</span>
        </button>
        <div class="my-4 border-t border-slate-100 mx-2"></div>
        <button
          onclick="switchView('settings')"
          id="nav-settings"
          class="nav-link w-full flex items-center gap-4 px-4 py-3.5 rounded-lg transition-all text-text-light hover:bg-slate-50 hover:text-primary"
        >
          <i class="fas fa-cog w-5 text-center"></i>
          <span class="text-sm font-medium">Configurações</span>
        </button>
      </nav>

      <div class="p-6 border-t border-slate-100 bg-white">
        <div class="text-center">
          <p class="text-[10px] text-slate-400 font-medium">
            &copy; 2025 Door & Design
          </p>
          <div class="flex items-center justify-center gap-2 mt-2">
            <span
              class="w-2 h-2 rounded-full bg-green-500 animate-pulse"
            ></span>
            <span class="text-[10px] text-slate-500 font-bold"
              >Sistema Online</span
            >
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
      <!-- Topbar Mobile -->
      <header
        class="md:hidden bg-white px-4 h-16 shadow-sm flex justify-between items-center z-10 sticky top-0"
      >
        <div class="flex items-center gap-2">
          <div
            class="w-9 h-9 bg-primary rounded-lg flex items-center justify-center text-white text-lg"
          >
            <i class="fas fa-layer-group text-brand text-sm"></i>
          </div>
          <span
            class="font-bold text-primary tracking-tight text-sm sm:text-base"
            >DOOR<span class="text-brand">&</span>DESIGN</span
          >
        </div>
        <button
          onclick="toggleMobileSidebar()"
          class="text-text-light p-2 hover:bg-slate-100 rounded-lg transition"
        >
          <i class="fas fa-bars text-lg"></i>
        </button>
      </header>

      <div
        id="content-area"
        class="flex-1 overflow-y-auto p-4 md:p-8 lg:p-10 relative scroll-smooth"
      >
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="view-section space-y-6 fade-in">
          <header
            class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 mb-4"
          >
            <div>
              <h2 class="text-xl sm:text-2xl font-bold text-primary">
                Painel de Controle
              </h2>
              <p class="text-text-light text-xs sm:text-sm">
                Dados sincronizados em tempo real
              </p>
            </div>
            <div class="text-left sm:text-right">
              <p
                class="text-xs text-slate-400 font-semibold uppercase tracking-wider"
              >
                Itens Totais
              </p>
              <p
                class="text-xl sm:text-2xl font-bold text-primary"
                id="dash-total-items"
              >
                ...
              </p>
            </div>
          </header>

          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 h-auto"
          >
            <!-- Critical Alert -->
            <div
              class="bg-white p-4 sm:p-6 rounded-2xl shadow-card border border-red-100 relative overflow-hidden flex flex-col min-h-[250px]"
            >
              <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4 z-10"
              >
                <h3
                  class="font-bold text-error flex items-center gap-2 text-sm sm:text-base"
                >
                  <i class="fas fa-bell"></i> Atenção Necessária
                </h3>
                <span
                  class="bg-red-50 text-error text-xs font-bold px-2 py-1 rounded-lg whitespace-nowrap"
                  id="dash-critical-count"
                  >0 itens</span
                >
              </div>
              <div
                class="flex-1 overflow-y-auto pr-2 space-y-3"
                id="dash-critical-list"
              >
                <div class="animate-pulse flex space-x-4">
                  <div class="flex-1 space-y-4 py-1">
                    <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                  </div>
                </div>
              </div>
              <button
                onclick="switchView('shopping')"
                class="w-full mt-4 bg-error/10 hover:bg-error/20 text-error font-semibold py-2 rounded-lg text-sm transition"
              >
                Ver Compras
              </button>
            </div>

            <!-- Chart -->
            <div
              class="bg-white p-4 sm:p-6 rounded-2xl shadow-card border border-slate-100 flex flex-col min-h-[250px]"
            >
              <h3
                class="font-bold text-primary mb-4 flex items-center gap-2 text-sm sm:text-base"
              >
                <i class="fas fa-chart-pie text-brand"></i> Distribuição
              </h3>
              <div
                class="flex-1 flex items-center justify-center relative min-h-[180px] sm:min-h-[200px]"
              >
                <canvas id="categoryChart"></canvas>
              </div>
            </div>

            <!-- Top Movers -->
            <div
              class="bg-white p-4 sm:p-6 rounded-2xl shadow-card border border-slate-100 flex flex-col min-h-[250px]"
            >
              <h3
                class="font-bold text-primary mb-4 flex items-center gap-2 text-sm sm:text-base"
              >
                <i class="fas fa-fire text-warning"></i> Maior Saída (Top 5)
              </h3>
              <div
                class="flex-1 overflow-y-auto space-y-0"
                id="dash-top-movers"
              ></div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div
            class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden"
          >
            <div
              class="p-4 sm:p-5 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 bg-slate-50/50"
            >
              <h3
                class="font-bold text-slate-700 text-xs sm:text-sm uppercase tracking-wide"
              >
                Últimas Movimentações (Global)
              </h3>
              <button
                onclick="switchView('history')"
                class="text-xs font-bold text-brand hover:underline whitespace-nowrap"
              >
                Ver Histórico
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm min-w-[500px]">
                <tbody
                  id="dash-recent-table"
                  class="divide-y divide-slate-50 text-slate-600"
                ></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- INVENTORY -->
        <div id="view-inventory" class="view-section hidden space-y-6 fade-in">
          <div
            class="flex flex-col gap-3 sm:gap-4 sticky top-0 bg-background/95 backdrop-blur z-20 pb-3 sm:pb-4 pt-2 border-b border-slate-200/60"
          >
            <div class="flex justify-between items-center">
              <h2 class="text-xl sm:text-2xl font-bold text-primary">
                Estoque
              </h2>
              <button
                onclick="openModal()"
                class="md:hidden bg-primary hover:bg-slate-800 text-white p-2.5 rounded-xl shadow-lg text-sm font-semibold transition"
              >
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full">
              <div class="relative flex-1 group">
                <input
                  type="text"
                  id="search-input"
                  onkeyup="renderInventory()"
                  placeholder="Buscar..."
                  class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 focus:border-brand focus:ring-4 focus:ring-brand/10 outline-none text-sm transition shadow-sm bg-white"
                />
                <i
                  class="fas fa-search absolute left-4 top-3 text-slate-400 group-focus-within:text-brand transition-colors"
                ></i>
              </div>
              <div class="flex gap-2 flex-shrink-0">
                <div class="relative flex-1 sm:flex-none">
                  <select
                    id="sort-select"
                    onchange="changeSort(this.value)"
                    class="h-full w-full sm:w-auto pl-3 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-medium text-slate-600 focus:border-brand outline-none appearance-none cursor-pointer hover:bg-slate-50"
                  >
                    <option value="name_asc">A-Z</option>
                    <option value="name_desc">Z-A</option>
                    <option value="qty_desc">Maior Qtd</option>
                    <option value="qty_asc">Menor Qtd</option>
                  </select>
                  <i
                    class="fas fa-sort absolute right-3 top-3.5 text-slate-400 pointer-events-none text-xs"
                  ></i>
                </div>
                <div
                  class="flex bg-white rounded-xl border border-slate-200 p-1"
                >
                  <button
                    onclick="toggleViewMode('grid')"
                    id="btn-view-grid"
                    class="p-2 rounded-lg text-slate-400 hover:text-brand transition active-view"
                  >
                    <i class="fas fa-th-large"></i>
                  </button>
                  <button
                    onclick="toggleViewMode('list')"
                    id="btn-view-list"
                    class="p-2 rounded-lg text-slate-400 hover:text-brand transition"
                  >
                    <i class="fas fa-list"></i>
                  </button>
                </div>
              </div>
              <button
                onclick="openModal()"
                class="hidden md:flex bg-primary hover:bg-slate-800 text-white px-4 py-2.5 rounded-xl shadow-lg shadow-slate-200 text-sm font-semibold transition transform hover:-translate-y-0.5 items-center justify-center gap-2"
              >
                <i class="fas fa-plus"></i>
                <span>Novo</span>
              </button>
            </div>
          </div>
          <div
            class="flex border-b border-slate-200 overflow-x-auto gap-3 sm:gap-6 -mx-4 px-4 md:mx-0 md:px-0"
            id="category-tabs-container"
            style="scrollbar-width: thin; -webkit-overflow-scrolling: touch"
          ></div>
          <div id="inventory-container" class="pb-20"></div>
        </div>

        <!-- SHOPPING LIST -->
        <div id="view-shopping" class="view-section hidden space-y-8 fade-in">
          <header
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-4 sm:p-6 rounded-2xl shadow-card border border-slate-100 gap-3 sm:gap-4"
          >
            <div class="w-full sm:w-auto">
              <h2 class="text-lg sm:text-xl font-bold text-primary">
                Central de Compras
              </h2>
              <p class="text-text-light text-xs sm:text-sm mt-1">
                Sincronizado com todos os usuários
              </p>
            </div>
            <button
              onclick="window.print()"
              class="text-slate-500 hover:text-primary bg-slate-50 border border-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 w-full sm:w-auto justify-center"
            >
              <i class="fas fa-print"></i> Imprimir Lista
            </button>
          </header>
          <div id="shopping-grid" class="space-y-4"></div>
          <div
            id="empty-state-shopping"
            class="hidden flex flex-col items-center justify-center py-24 text-center"
          >
            <div
              class="w-20 h-20 bg-emerald-50 rounded-full flex items-center justify-center mb-6 shadow-sm"
            >
              <i class="fas fa-check text-3xl text-success"></i>
            </div>
            <h3 class="text-xl font-bold text-primary">Estoque Abastecido!</h3>
          </div>
        </div>

        <!-- HISTORY -->
        <div
          id="view-history"
          class="view-section hidden space-y-4 sm:space-y-6 fade-in"
        >
          <header>
            <h2 class="text-xl sm:text-2xl font-bold text-primary">
              Histórico
            </h2>
          </header>
          <div
            class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden"
          >
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm min-w-[600px]">
                <thead
                  class="bg-slate-50/80 border-b border-slate-100 text-text-light font-semibold uppercase text-xs tracking-wider"
                >
                  <tr>
                    <th class="p-3 sm:p-5">Data</th>
                    <th class="p-3 sm:p-5">Item</th>
                    <th class="p-3 sm:p-5 text-center">Tipo</th>
                    <th class="p-3 sm:p-5 hidden sm:table-cell">Detalhes</th>
                    <th class="p-3 sm:p-5 text-right">Qtd</th>
                  </tr>
                </thead>
                <tbody
                  id="history-table-body"
                  class="divide-y divide-slate-50 text-slate-700"
                ></tbody>
              </table>
            </div>
            <div
              id="empty-history"
              class="p-12 text-center text-text-light hidden"
            >
              Nenhum registro.
            </div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div
          id="view-settings"
          class="view-section hidden space-y-6 sm:space-y-8 fade-in"
        >
          <header>
            <h2 class="text-xl sm:text-2xl font-bold text-primary">
              Configurações
            </h2>
          </header>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 sm:gap-8">
            <div
              class="bg-white p-5 sm:p-8 rounded-2xl shadow-card border border-slate-100 md:col-span-2"
            >
              <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-6"
              >
                <div>
                  <h3
                    class="font-bold text-lg text-primary flex items-center gap-2"
                  >
                    <i class="fas fa-layer-group text-brand"></i> Categorias
                  </h3>
                </div>
                <button
                  onclick="openCategoryModal()"
                  class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm hover:bg-slate-800 transition shadow-lg shadow-slate-200"
                >
                  <i class="fas fa-plus mr-2"></i> Nova
                </button>
              </div>
              <div class="overflow-hidden rounded-xl border border-slate-100">
                <table class="w-full text-sm text-left">
                  <thead
                    class="bg-slate-50 text-xs font-bold text-text-light uppercase"
                  >
                    <tr>
                      <th class="p-4">Nome</th>
                      <th class="p-4 text-center">Itens</th>
                      <th class="p-4 text-right">Ações</th>
                    </tr>
                  </thead>
                  <tbody
                    id="category-table-body"
                    class="divide-y divide-slate-50 bg-white"
                  ></tbody>
                </table>
              </div>
            </div>
            <div
              class="bg-white p-8 rounded-2xl shadow-card border border-slate-100"
            >
              <h3 class="font-bold text-lg text-primary mb-2">
                Status da Nuvem
              </h3>
              <p class="text-sm text-slate-500 mb-4">
                Seus dados estão seguros nos servidores do Google.
              </p>
              <div
                class="flex items-center gap-2 text-success font-bold bg-green-50 p-3 rounded-xl border border-green-100"
              >
                <i class="fas fa-cloud-upload-alt"></i> Sincronizado
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Modals -->
    <div
      id="modal-form"
      class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-2 sm:p-4 transition-opacity opacity-0"
    >
      <div
        class="bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full max-w-2xl transform scale-95 transition-all flex flex-col max-h-[95vh] sm:max-h-[90vh]"
      >
        <div
          class="px-4 py-4 sm:px-8 sm:py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-xl sm:rounded-t-2xl"
        >
          <h3
            class="text-lg sm:text-xl font-bold text-primary"
            id="modal-title"
          >
            Novo Item
          </h3>
          <button
            onclick="closeModal()"
            class="text-slate-400 hover:text-primary transition bg-white p-2 rounded-full shadow-sm hover:shadow"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="p-4 sm:p-8 overflow-y-auto">
          <form
            id="item-form"
            onsubmit="handleFormSubmit(event)"
            class="space-y-6"
          >
            <input type="hidden" id="editItemId" />
            <div class="flex flex-col gap-5 sm:gap-8">
              <div class="w-full">
                <label
                  class="block text-xs font-bold text-text-light uppercase tracking-wide mb-2"
                  >Imagem</label
                >
                <div
                  class="border-2 border-dashed border-slate-300 rounded-2xl bg-slate-50 h-40 sm:h-48 flex flex-col items-center justify-center cursor-pointer hover:border-brand hover:bg-orange-50 transition relative overflow-hidden group"
                  onclick="document.getElementById('fileInput').click()"
                >
                  <input
                    type="file"
                    id="fileInput"
                    accept="image/*"
                    class="hidden"
                    onchange="processImage(this)"
                  />
                  <div
                    id="upload-placeholder"
                    class="text-center p-4 transition-opacity group-hover:opacity-70"
                  >
                    <div
                      class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-slate-400 mx-auto mb-3"
                    >
                      <i class="fas fa-camera text-xl"></i>
                    </div>
                    <p class="text-xs text-slate-500 font-medium">
                      Clique para adicionar
                    </p>
                  </div>
                  <img
                    id="img-preview"
                    class="hidden w-full h-full object-contain absolute inset-0 z-10 bg-white p-2"
                  />
                  <button
                    type="button"
                    id="btn-remove-img"
                    onclick="removeImage(event)"
                    class="hidden absolute top-2 right-2 z-20 bg-white text-error rounded-full w-8 h-8 items-center justify-center shadow-md hover:bg-slate-50 transition"
                  >
                    <i class="fas fa-trash-alt text-sm"></i>
                  </button>
                </div>
                <input type="hidden" id="imgBase64" />
              </div>
              <div class="w-full space-y-4 sm:space-y-5">
                <div>
                  <label
                    class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                    >Nome *</label
                  ><input
                    type="text"
                    id="inpName"
                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-brand outline-none"
                    required
                  />
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-5">
                  <div>
                    <label
                      class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                      >Categoria *</label
                    >
                    <div class="relative">
                      <select
                        id="inpCategory"
                        class="w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-brand outline-none bg-white appearance-none cursor-pointer"
                      ></select
                      ><i
                        class="fas fa-chevron-down absolute right-4 top-3 text-slate-400 text-xs pointer-events-none"
                      ></i>
                    </div>
                  </div>
                  <div>
                    <label
                      class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                      >Tag</label
                    ><input
                      type="text"
                      id="inpTag"
                      class="w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-brand outline-none"
                    />
                  </div>
                </div>
                <div>
                  <label
                    class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                    >Fornecedor</label
                  >
                  <div class="relative">
                    <i
                      class="fas fa-truck absolute left-4 top-3 text-slate-400 text-sm"
                    ></i
                    ><input
                      type="text"
                      id="inpSupplier"
                      class="w-full pl-10 px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-brand outline-none"
                    />
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3 sm:gap-5 pt-2">
                  <div
                    class="bg-slate-50 p-3 rounded-xl border border-slate-100"
                  >
                    <label
                      class="block text-[10px] font-bold text-slate-500 uppercase mb-1"
                      >Atual</label
                    ><input
                      type="number"
                      id="inpQty"
                      class="w-full bg-transparent font-bold text-lg sm:text-xl text-primary outline-none"
                      required
                      min="0"
                    />
                  </div>
                  <div class="bg-red-50 p-3 rounded-xl border border-red-100">
                    <label
                      class="block text-[10px] font-bold text-error uppercase mb-1"
                      >Mínimo</label
                    ><input
                      type="number"
                      id="inpMin"
                      class="w-full bg-transparent font-bold text-lg sm:text-xl text-error outline-none"
                      required
                      min="1"
                    />
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div
          class="px-4 py-4 sm:px-8 sm:py-5 bg-slate-50 border-t border-slate-100 flex gap-3 rounded-b-xl sm:rounded-b-2xl"
        >
          <button
            onclick="closeModal()"
            class="flex-1 sm:flex-none px-4 sm:px-5 py-2.5 border border-slate-200 rounded-xl text-sm font-semibold text-slate-600 hover:bg-white hover:border-slate-300 transition shadow-sm"
          >
            Cancelar
          </button>
          <button
            onclick="document.getElementById('item-form').requestSubmit()"
            class="flex-1 sm:flex-none px-4 sm:px-5 py-2.5 bg-primary text-white rounded-xl text-sm font-semibold hover:bg-slate-800 shadow-lg shadow-slate-200 transition transform active:scale-95"
          >
            Salvar
          </button>
        </div>
      </div>
    </div>

    <div
      id="modal-category"
      class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity opacity-0"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-all"
      >
        <div
          class="p-6 border-b border-slate-100 flex justify-between items-center"
        >
          <h3 class="text-lg font-bold text-primary" id="cat-modal-title">
            Categoria
          </h3>
          <button
            onclick="closeCategoryModal()"
            class="text-slate-400 hover:text-primary"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="p-6">
          <form id="cat-form" onsubmit="handleCategorySubmit(event)">
            <input type="hidden" id="editCatOldName" /><label
              class="block text-xs font-bold text-text-light uppercase tracking-wide mb-2"
              >Nome</label
            ><input
              type="text"
              id="catNameInput"
              class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm focus:border-brand outline-none mb-6"
              required
            /><button
              type="submit"
              class="w-full bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-slate-800 transition"
            >
              Salvar
            </button>
          </form>
        </div>
      </div>
    </div>

    <div
      id="modal-receive"
      class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity opacity-0"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-all"
      >
        <div
          class="p-6 bg-emerald-50 rounded-t-2xl border-b border-emerald-100"
        >
          <h3 class="text-lg font-bold text-emerald-900">Receber Item</h3>
          <p class="text-emerald-700 text-sm" id="receive-item-name">Item</p>
        </div>
        <div class="p-6">
          <form
            id="receive-form"
            onsubmit="handleReceiveSubmit(event)"
            class="space-y-4"
          >
            <input type="hidden" id="receiveItemId" />
            <div>
              <label
                class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                >Qtd Recebida</label
              ><input
                type="number"
                id="receiveQty"
                class="w-full px-4 py-3 border border-slate-200 rounded-xl text-lg font-bold text-primary focus:border-success outline-none"
                required
                min="1"
              />
              <p class="text-xs text-slate-400 mt-1">
                Sugestão:
                <span id="receive-suggested" class="font-bold">0</span>
              </p>
            </div>
            <div>
              <label
                class="block text-xs font-bold text-text-light uppercase tracking-wide mb-1.5"
                >Custo Un.</label
              >
              <div class="relative">
                <span class="absolute left-4 top-3 text-slate-400 text-sm"
                  >R$</span
                ><input
                  type="number"
                  id="receiveCost"
                  step="0.01"
                  class="w-full pl-10 px-4 py-3 border border-slate-200 rounded-xl text-sm focus:border-success outline-none"
                  placeholder="0.00"
                />
              </div>
            </div>
            <div class="flex gap-3 pt-2">
              <button
                type="button"
                onclick="closeReceiveModal()"
                class="flex-1 py-3 border border-slate-200 rounded-xl font-bold text-sm text-slate-600 hover:bg-slate-50 transition"
              >
                Cancelar</button
              ><button
                type="submit"
                class="flex-1 py-3 bg-success text-white rounded-xl font-bold text-sm shadow-lg shadow-emerald-200 hover:bg-emerald-600 transition"
              >
                Confirmar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        doc,
        updateDoc,
        deleteDoc,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // CONFIGURAÇÃO DO FIREBASE
      let firebaseConfig;
      if (typeof __firebase_config !== "undefined") {
        firebaseConfig = JSON.parse(__firebase_config);
      } else {
        // --- COLE SUAS CHAVES AQUI ---
        firebaseConfig = {
          apiKey: "AIzaSyDncL4re72Cf9A3fBH2sf_PwhHNTKPWLC0",
          authDomain: "ded-gestao-de-estoque.firebaseapp.com",
          projectId: "ded-gestao-de-estoque",
          storageBucket: "ded-gestao-de-estoque.firebasestorage.app",
          messagingSenderId: "21564288686",
          appId: "1:21564288686:web:1827ddc1b12ecd7ad4073f",
        };
      }

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "door-design-matriz";

      let inventory = [],
        categories = [],
        historyLog = [],
        activeTab = "Todas";
      let viewMode = localStorage.getItem("dd_view_mode") || "grid",
        sortMode = "name_asc",
        categoryChartInstance = null;

      async function initApp() {
        try {
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          )
            await signInWithCustomToken(auth, __initial_auth_token);
          else await signInAnonymously(auth);

          setupRealtimeListeners();
          document
            .getElementById("loading-screen")
            .classList.add("opacity-0", "pointer-events-none");

          // Expose Globals
          Object.assign(window, {
            openModal,
            closeModal,
            processImage,
            removeImage,
            handleFormSubmit,
            deleteItem,
            updateStockDirect,
            switchView,
            toggleViewMode,
            changeSort,
            renderInventory,
            openCategoryModal,
            closeCategoryModal,
            handleCategorySubmit,
            deleteCategory,
            openReceiveModal,
            closeReceiveModal,
            handleReceiveSubmit,
            setActiveTab,
            prepareEdit,
            toggleMobileSidebar,
          });

          switchView("dashboard");
        } catch (error) {
          console.error("Auth Err", error);
        }
      }

      function setupRealtimeListeners() {
        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "inventory"),
          (snap) => {
            inventory = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
            renderGlobalUI();
          }
        );
        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "categories"),
          (snap) => {
            const docs = snap.docs.map((doc) => doc.data().name);
            categories =
              docs.length > 0
                ? docs
                : ["Geral", "Portas", "Fechaduras", "Ferragens"];
            renderCategoryTabs();
            renderCategoryTable();
            updateGlobalCharts();
          }
        );
        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "history"),
          (snap) => {
            historyLog = snap.docs
              .map((doc) => ({ id: doc.id, ...doc.data() }))
              .sort((a, b) => new Date(b.date) - new Date(a.date));
            renderHistory();
          }
        );
      }

      async function logAction(itemName, action, change, details = "") {
        try {
          await addDoc(
            collection(db, "artifacts", appId, "public", "data", "history"),
            {
              date: new Date().toISOString(),
              itemName,
              action,
              change,
              details,
            }
          );
        } catch (e) {}
      }

      async function handleFormSubmit(e) {
        e.preventDefault();
        const id = document.getElementById("editItemId").value;
        const data = {
          name: document.getElementById("inpName").value,
          category: document.getElementById("inpCategory").value,
          tag: document.getElementById("inpTag").value,
          supplier: document.getElementById("inpSupplier").value,
          qty: parseInt(document.getElementById("inpQty").value),
          min: parseInt(document.getElementById("inpMin").value),
          image: document.getElementById("imgBase64").value || null,
          updatedAt: new Date().toISOString(),
        };
        try {
          if (id) {
            await updateDoc(
              doc(db, "artifacts", appId, "public", "data", "inventory", id),
              data
            );
            logAction(data.name, "Edição", 0);
            showToast("Item atualizado!", "success");
          } else {
            data.createdAt = new Date().toISOString();
            await addDoc(
              collection(db, "artifacts", appId, "public", "data", "inventory"),
              data
            );
            logAction(data.name, "Criação", data.qty);
            showToast("Item criado!", "success");
          }
          closeModal();
        } catch (err) {
          alert("Erro: " + err.message);
        }
      }

      async function updateStockDirect(id, change) {
        const item = inventory.find((i) => i.id === id);
        if (!item) return;
        try {
          const newQty = Math.max(0, item.qty + change);
          await updateDoc(
            doc(db, "artifacts", appId, "public", "data", "inventory", id),
            { qty: newQty }
          );
          logAction(item.name, change > 0 ? "Ajuste (+)" : "Retirada", change);
          showToast(`Estoque: ${newQty}`, "success");
        } catch (e) {
          alert("Erro conexão");
        }
      }

      async function deleteItem(id) {
        if (!confirm("Excluir?")) return;
        const item = inventory.find((i) => i.id === id);
        try {
          await deleteDoc(
            doc(db, "artifacts", appId, "public", "data", "inventory", id)
          );
          logAction(item ? item.name : "Item", "Exclusão", 0);
          showToast("Excluído", "default");
        } catch (e) {
          alert(e.message);
        }
      }

      async function handleReceiveSubmit(e) {
        e.preventDefault();
        const id = document.getElementById("receiveItemId").value;
        const qty = parseInt(document.getElementById("receiveQty").value);
        const cost = document.getElementById("receiveCost").value;
        const item = inventory.find((i) => i.id === id);
        if (item && qty > 0) {
          try {
            await updateDoc(
              doc(db, "artifacts", appId, "public", "data", "inventory", id),
              { qty: item.qty + qty }
            );
            logAction(
              item.name,
              "Recebimento",
              qty,
              cost ? `Custo: R$${cost}` : ""
            );
            showToast("Recebido!", "success");
            closeReceiveModal();
          } catch (err) {
            alert("Erro ao receber");
          }
        }
      }

      async function handleCategorySubmit(e) {
        e.preventDefault();
        const newName = document.getElementById("catNameInput").value.trim();
        if (!newName || categories.includes(newName)) return alert("Inválido");
        try {
          await addDoc(
            collection(db, "artifacts", appId, "public", "data", "categories"),
            { name: newName }
          );
          showToast("Categoria criada", "success");
          closeCategoryModal();
        } catch (err) {}
      }
      async function deleteCategory(catName) {
        alert(
          "Exclusão de categorias deve ser feita no painel admin para segurança."
        );
      }

      function renderGlobalUI() {
        renderInventory();
        renderShopping();
        renderHistory();
        updateDashboard();
      }

      function renderInventory() {
        const container = document.getElementById("inventory-container");
        const term = document
          .getElementById("search-input")
          .value.toLowerCase();
        container.innerHTML = "";
        let filtered = inventory.filter((i) => {
          return (
            (i.name.toLowerCase().includes(term) ||
              (i.tag && i.tag.toLowerCase().includes(term)) ||
              (i.supplier && i.supplier.toLowerCase().includes(term))) &&
            (activeTab === "Todas" || i.category === activeTab)
          );
        });
        filtered.sort((a, b) => {
          if (sortMode === "name_asc") return a.name.localeCompare(b.name);
          if (sortMode === "name_desc") return b.name.localeCompare(a.name);
          if (sortMode === "qty_asc") return a.qty - b.qty;
          return b.qty - a.qty;
        });

        if (filtered.length === 0) {
          container.innerHTML = `<div class="py-12 text-center text-text-light flex flex-col items-center"><i class="fas fa-search text-4xl mb-3 text-slate-200"></i><p>Nada encontrado.</p></div>`;
          return;
        }

        if (viewMode === "grid") {
          let html =
            '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">';
          filtered.forEach((item) => {
            const isCrit = item.qty < item.min,
              pct = Math.min(100, (item.qty / (item.min * 2)) * 100),
              bar = isCrit
                ? "bg-error"
                : item.qty === item.min
                ? "bg-warning"
                : "bg-success";
            const img = item.image
              ? `<img src="${item.image}" class="card-img">`
              : `<div class="flex flex-col items-center justify-center h-full text-slate-300"><i class="fas fa-image text-3xl"></i></div>`;
            html += `<div class="inventory-card bg-white rounded-2xl shadow-card border border-slate-100 hover:shadow-floating transition-all overflow-hidden flex flex-col group relative ${
              isCrit ? "ring-2 ring-error" : ""
            }">
                            <div class="card-img-wrapper">${img}
                                <div class="absolute inset-0 bg-slate-900/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-3 backdrop-blur-[2px]">
                                     <button onclick="prepareEdit('${
                                       item.id
                                     }')" class="bg-white text-slate-800 w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition"><i class="fas fa-pen"></i></button>
                                     <button onclick="deleteItem('${
                                       item.id
                                     }')" class="bg-white text-error w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition"><i class="fas fa-trash"></i></button>
                                </div>
                                <div class="absolute top-3 right-3 bg-white/95 px-2 py-1 rounded-lg text-[10px] font-bold shadow-sm text-slate-600">${
                                  item.category
                                }</div>
                                ${
                                  isCrit
                                    ? '<div class="absolute top-3 left-3 bg-error text-white px-2 py-1 rounded-lg text-[10px] font-bold animate-pulse">Repor</div>'
                                    : ""
                                }
                            </div>
                            <div class="p-5 flex-1 flex flex-col"><div class="mb-1"><h4 class="font-bold text-slate-800 text-base leading-tight line-clamp-2" title="${
                              item.name
                            }">${
              item.name
            }</h4><p class="text-xs text-slate-400 truncate"><i class="fas fa-truck mr-1"></i>${
              item.supplier || "N/A"
            }</p></div>
                                <div class="flex flex-wrap items-center gap-2 mb-4 mt-2">${
                                  item.tag
                                    ? `<span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-md font-bold">#${item.tag}</span>`
                                    : ""
                                }</div>
                                <div class="mt-auto"><div class="flex justify-between items-end mb-1 text-sm"><span class="text-slate-500 text-xs font-bold uppercase">Estoque</span><span class="text-slate-400 text-xs">Min: ${
                                  item.min
                                }</span></div>
                                    <div class="flex items-center justify-between mb-2"><span class="text-2xl font-bold ${
                                      isCrit ? "text-error" : "text-slate-700"
                                    }">${
              item.qty
            }</span><div class="w-1/2 h-2 bg-slate-100 rounded-full overflow-hidden ml-3"><div class="h-full ${bar}" style="width: ${pct}%"></div></div></div>
                                    <div class="flex gap-2 mt-3"><button onclick="updateStockDirect('${
                                      item.id
                                    }', -1)" class="flex-1 h-9 flex items-center justify-center border border-slate-200 rounded-lg hover:bg-slate-50 text-slate-500 transition"><i class="fas fa-minus"></i></button><button onclick="updateStockDirect('${
              item.id
            }', 1)" class="flex-1 h-9 flex items-center justify-center bg-primary text-white rounded-lg hover:bg-slate-800 shadow-md transition"><i class="fas fa-plus"></i></button></div>
                                </div></div></div>`;
          });
          container.innerHTML = html + "</div>";
        } else {
          let html = `<div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-text-light font-bold text-xs uppercase"><tr><th class="p-4 w-12"></th><th class="p-4">Item</th><th class="p-4 hidden md:table-cell">Categoria</th><th class="p-4 text-center">Status</th><th class="p-4 text-right">Ações</th></tr></thead><tbody class="divide-y divide-slate-50">`;
          filtered.forEach((item) => {
            const isCrit = item.qty < item.min,
              img = item.image
                ? `<img src="${item.image}" class="w-10 h-10 rounded object-cover">`
                : `<div class="w-10 h-10 bg-slate-100 rounded flex items-center justify-center text-slate-400"><i class="fas fa-box"></i></div>`;
            html += `<tr class="hover:bg-slate-50 transition"><td class="p-4">${img}</td><td class="p-4"><div class="font-bold text-slate-800">${
              item.name
            }</div><div class="text-xs text-slate-400 sm:hidden">${
              item.category
            }</div></td><td class="p-4 hidden md:table-cell"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs">${
              item.category
            }</span></td><td class="p-4 text-center"><div class="flex items-center justify-center gap-2"><button onclick="updateStockDirect('${
              item.id
            }', -1)" class="w-6 h-6 rounded bg-slate-100 hover:bg-slate-200 text-slate-600">-</button><span class="font-bold w-8 text-center ${
              isCrit ? "text-error" : "text-slate-700"
            }">${item.qty}</span><button onclick="updateStockDirect('${
              item.id
            }', 1)" class="w-6 h-6 rounded bg-slate-100 hover:bg-slate-200 text-slate-600">+</button></div></td><td class="p-4 text-right"><button onclick="prepareEdit('${
              item.id
            }')" class="text-blue-600 p-2"><i class="fas fa-pen"></i></button><button onclick="deleteItem('${
              item.id
            }')" class="text-error p-2"><i class="fas fa-trash"></i></button></td></tr>`;
          });
          container.innerHTML = html + "</tbody></table></div>";
        }
      }

      function renderShopping() {
        const grid = document.getElementById("shopping-grid");
        const empty = document.getElementById("empty-state-shopping");
        grid.innerHTML = "";
        const toBuy = inventory.filter((i) => i.qty < i.min);
        if (toBuy.length === 0) {
          empty.classList.remove("hidden");
          return;
        }
        empty.classList.add("hidden");
        toBuy.forEach((item) => {
          const sug = Math.ceil(item.min * 1.5) - item.qty;
          const img = item.image
            ? `<img src="${item.image}" class="w-full h-full object-cover">`
            : '<i class="fas fa-shopping-basket text-xl"></i>';
          grid.innerHTML += `<div class="bg-white p-5 rounded-xl shadow-card border border-slate-100 flex flex-col md:flex-row items-center gap-6 hover:shadow-md transition relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-error"></div>
                        <div class="w-16 h-16 rounded-xl bg-slate-50 text-slate-400 flex items-center justify-center shrink-0 border border-slate-100 overflow-hidden">${img}</div>
                        <div class="flex-1 text-center md:text-left w-full"><h4 class="font-bold text-slate-800 text-lg">${
                          item.name
                        }</h4><div class="text-xs text-text-light mt-1">Fornecedor: ${
            item.supplier || "-"
          } • Atual: <span class="font-bold text-error">${
            item.qty
          }</span> / Mín: ${item.min}</div></div>
                        <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end bg-slate-50 p-3 rounded-xl md:bg-transparent md:p-0"><div class="text-right px-2"><div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">Sugestão</div><div class="text-xl font-bold text-primary">+${sug}</div></div><button onclick="openReceiveModal('${
            item.id
          }', ${sug})" class="bg-success text-white px-5 py-2.5 rounded-xl shadow-lg hover:bg-emerald-600 transition text-sm font-bold flex items-center gap-2"><i class="fas fa-check"></i> Receber</button></div></div>`;
        });
      }

      function renderHistory() {
        const tbody = document.getElementById("history-table-body"),
          dashTable = document.getElementById("dash-recent-table");
        const html = historyLog
          .map((log) => {
            const d = new Date(log.date),
              isPos = log.change > 0;
            return `<tr class="hover:bg-slate-50"><td class="p-3 sm:p-5 whitespace-nowrap text-slate-500 font-mono text-xs">${d.toLocaleDateString(
              "pt-BR"
            )} ${d.toLocaleTimeString("pt-BR", {
              hour: "2-digit",
              minute: "2-digit",
            })}</td><td class="p-3 sm:p-5 font-bold text-slate-700 text-xs sm:text-sm">${
              log.itemName
            }</td><td class="p-3 sm:p-5 text-center"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${
              isPos
                ? "bg-emerald-50 text-success"
                : "bg-orange-50 text-orange-600"
            }">${
              log.action
            }</span></td><td class="p-3 sm:p-5 text-xs text-slate-500 hidden sm:table-cell">${
              log.details || "-"
            }</td><td class="p-3 sm:p-5 text-right font-mono font-bold text-sm ${
              isPos ? "text-success" : "text-error"
            }">${isPos ? "+" : ""}${log.change}</td></tr>`;
          })
          .join("");
        if (tbody)
          tbody.innerHTML =
            html ||
            '<tr><td colspan="5" class="p-8 text-center text-slate-400">Vazio</td></tr>';
        if (dashTable)
          dashTable.innerHTML =
            historyLog
              .slice(0, 5)
              .map(
                (log) =>
                  `<tr class="hover:bg-slate-50"><td class="p-4 text-xs text-slate-400">${new Date(
                    log.date
                  ).toLocaleDateString()}</td><td class="p-4 text-sm font-bold text-slate-700">${
                    log.itemName
                  }</td><td class="p-4 text-right text-sm font-bold ${
                    log.change > 0 ? "text-success" : "text-error"
                  }">${log.change > 0 ? "+" : ""}${log.change}</td></tr>`
              )
              .join("") ||
            '<tr><td colspan="3" class="p-4 text-center text-xs text-slate-400">Vazio</td></tr>';
      }

      function updateDashboard() {
        const critical = inventory.filter((i) => i.qty < i.min);
        document.getElementById("dash-total-items").innerText =
          inventory.length;
        document.getElementById(
          "dash-critical-count"
        ).innerText = `${critical.length} itens`;
        const listEl = document.getElementById("dash-critical-list");
        if (listEl)
          listEl.innerHTML =
            critical.length === 0
              ? '<div class="text-center py-4 text-slate-400 text-sm">Tudo OK!</div>'
              : critical
                  .slice(0, 5)
                  .map(
                    (i) =>
                      `<div class="flex justify-between items-center bg-red-50/50 p-3 rounded-xl border border-red-100 cursor-pointer" onclick="openReceiveModal('${
                        i.id
                      }', ${
                        Math.ceil(i.min * 1.5) - i.qty
                      })"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-white text-error flex items-center justify-center font-bold text-xs border border-red-100">${
                        i.qty
                      }</div><div><p class="text-sm font-bold text-slate-700 truncate w-32">${
                        i.name
                      }</p><p class="text-[10px] text-slate-400">Min: ${
                        i.min
                      }</p></div></div><i class="fas fa-chevron-right text-xs text-red-300"></i></div>`
                  )
                  .join("");
        updateGlobalCharts();

        // Calculate Top Movers
        const outputMap = {};
        historyLog.forEach((l) => {
          if (l.change < 0)
            outputMap[l.itemName] =
              (outputMap[l.itemName] || 0) + Math.abs(l.change);
        });
        const topMovers = Object.entries(outputMap)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        const moveEl = document.getElementById("dash-top-movers");
        if (moveEl)
          moveEl.innerHTML =
            topMovers.length === 0
              ? '<p class="text-center text-xs text-slate-400 py-4">Sem dados</p>'
              : topMovers
                  .map(
                    ([n, c], i) =>
                      `<div class="flex justify-between py-2 border-b border-slate-50 text-sm"><span class="text-slate-600">#${
                        i + 1
                      } ${n}</span><span class="font-bold text-brand">${c}</span></div>`
                  )
                  .join("");
      }

      function updateGlobalCharts() {
        const ctx = document.getElementById("categoryChart");
        if (!ctx) return;
        const counts = {};
        inventory.forEach(
          (i) => (counts[i.category] = (counts[i.category] || 0) + 1)
        );
        if (categoryChartInstance) categoryChartInstance.destroy();
        categoryChartInstance = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: Object.keys(counts),
            datasets: [
              {
                data: Object.values(counts),
                backgroundColor: [
                  "#3b82f6",
                  "#10b981",
                  "#f59e0b",
                  "#ef4444",
                  "#8b5cf6",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%",
            plugins: {
              legend: { position: "right", labels: { boxWidth: 10 } },
            },
          },
        });
      }

      // --- Modals & Utils ---
      function openModal() {
        document.getElementById("modal-form").classList.remove("hidden");
        setTimeout(() => {
          document
            .getElementById("modal-form")
            .children[0].classList.remove("scale-95");
          document.getElementById("modal-form").classList.remove("opacity-0");
        }, 10);
        if (!document.getElementById("editItemId").value) {
          document.getElementById("item-form").reset();
          removeImage({ stopPropagation: () => {} });
          populateCategorySelect();
        }
      }
      function closeModal() {
        document.getElementById("modal-form").classList.add("opacity-0");
        setTimeout(() => {
          document.getElementById("modal-form").classList.add("hidden");
          document.getElementById("editItemId").value = "";
        }, 200);
      }
      function openReceiveModal(id, sug) {
        const item = inventory.find((i) => i.id === id);
        if (!item) return;
        document.getElementById("receiveItemId").value = id;
        document.getElementById("receive-item-name").innerText = item.name;
        document.getElementById("receiveQty").value = sug;
        document.getElementById("receive-suggested").innerText = sug;
        document.getElementById("receiveCost").value = "";
        document.getElementById("modal-receive").classList.remove("hidden");
        setTimeout(
          () =>
            document
              .getElementById("modal-receive")
              .classList.remove("opacity-0"),
          10
        );
        setTimeout(() => document.getElementById("receiveQty").focus(), 100);
      }
      function closeReceiveModal() {
        document.getElementById("modal-receive").classList.add("opacity-0");
        setTimeout(
          () =>
            document.getElementById("modal-receive").classList.add("hidden"),
          200
        );
      }
      function openCategoryModal() {
        document.getElementById("modal-category").classList.remove("hidden");
        setTimeout(
          () =>
            document
              .getElementById("modal-category")
              .classList.remove("opacity-0"),
          10
        );
      }
      function closeCategoryModal() {
        document.getElementById("modal-category").classList.add("opacity-0");
        setTimeout(
          () =>
            document.getElementById("modal-category").classList.add("hidden"),
          200
        );
      }
      function prepareEdit(id) {
        const item = inventory.find((i) => i.id === id);
        if (!item) return;
        populateCategorySelect();
        document.getElementById("modal-title").innerText = "Editar";
        document.getElementById("editItemId").value = id;
        document.getElementById("inpName").value = item.name;
        document.getElementById("inpCategory").value = item.category;
        document.getElementById("inpTag").value = item.tag || "";
        document.getElementById("inpSupplier").value = item.supplier || "";
        document.getElementById("inpQty").value = item.qty;
        document.getElementById("inpMin").value = item.min;
        if (item.image) {
          document.getElementById("imgBase64").value = item.image;
          document.getElementById("img-preview").src = item.image;
          document.getElementById("img-preview").classList.remove("hidden");
          document.getElementById("upload-placeholder").classList.add("hidden");
        } else removeImage({ stopPropagation: () => {} });
        openModal();
      }
      function populateCategorySelect() {
        document.getElementById("inpCategory").innerHTML = categories
          .map((c) => `<option value="${c}">${c}</option>`)
          .join("");
      }
      function renderCategoryTabs() {
        document.getElementById("category-tabs-container").innerHTML =
          `<button onclick="setActiveTab('Todas')" class="tab-btn px-4 py-3 text-sm font-medium ${
            activeTab === "Todas" ? "active" : ""
          }">Todas</button>` +
          categories
            .map(
              (c) =>
                `<button onclick="setActiveTab('${c}')" class="tab-btn px-4 py-3 text-sm font-medium ${
                  activeTab === c ? "active" : ""
                }">${c}</button>`
            )
            .join("");
      }
      function renderCategoryTable() {
        const tbody = document.getElementById("category-table-body");
        if (tbody)
          tbody.innerHTML = categories
            .map(
              (c) =>
                `<tr class="hover:bg-slate-50"><td class="p-4 font-medium">${c}</td><td class="p-4 text-center text-slate-500">${
                  inventory.filter((i) => i.category === c).length
                }</td><td class="p-4 text-right"><button onclick="deleteCategory('${c}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`
            )
            .join("");
      }
      function setActiveTab(t) {
        activeTab = t;
        renderCategoryTabs();
        renderInventory();
      }
      function changeSort(m) {
        sortMode = m;
        renderInventory();
      }
      function toggleViewMode(m) {
        viewMode = m;
        localStorage.setItem("dd_view_mode", m);
        renderInventory();
      }
      function showToast(m, t = "info") {
        const el = document.createElement("div");
        el.className = `toast border-l-4 ${
          t === "success" ? "border-green-500" : "border-blue-900"
        }`;
        el.innerHTML = `<span class="font-bold text-slate-700">${m}</span>`;
        document.getElementById("toast-container").appendChild(el);
        requestAnimationFrame(() => el.classList.add("show"));
        setTimeout(() => {
          el.classList.remove("show");
          setTimeout(() => el.remove(), 400);
        }, 3000);
      }
      function processImage(input) {
        if (input.files && input.files[0]) {
          const r = new FileReader();
          r.onload = function (e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function () {
              const c = document.createElement("canvas"),
                MAX = 500,
                scale = MAX / img.width;
              c.width = MAX;
              c.height = img.height * scale;
              const ctx = c.getContext("2d");
              ctx.drawImage(img, 0, 0, c.width, c.height);
              const d = c.toDataURL("image/jpeg", 0.8);
              document.getElementById("imgBase64").value = d;
              document.getElementById("img-preview").src = d;
              document.getElementById("img-preview").classList.remove("hidden");
              document
                .getElementById("upload-placeholder")
                .classList.add("hidden");
            };
          };
          r.readAsDataURL(input.files[0]);
        }
      }
      function removeImage(e) {
        e.stopPropagation();
        document.getElementById("fileInput").value = "";
        document.getElementById("imgBase64").value = "";
        document.getElementById("img-preview").classList.add("hidden");
        document
          .getElementById("upload-placeholder")
          .classList.remove("hidden");
      }
      function toggleMobileSidebar() {
        const sidebar = document.getElementById("main-sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        sidebar.classList.toggle("mobile-open");
        overlay.classList.toggle("active");
      }

      function switchView(v) {
        document
          .querySelectorAll(".view-section")
          .forEach((e) => e.classList.add("hidden"));
        document.getElementById(`view-${v}`).classList.remove("hidden");
        document
          .querySelectorAll(".nav-link")
          .forEach((e) => e.classList.remove("active"));
        document.getElementById(`nav-${v}`).classList.add("active");

        // Fechar sidebar mobile ao trocar de view
        if (window.innerWidth < 768) {
          const sidebar = document.getElementById("main-sidebar");
          const overlay = document.getElementById("sidebar-overlay");
          sidebar.classList.remove("mobile-open");
          overlay.classList.remove("active");
        }

        if (v === "inventory") {
          renderCategoryTabs();
          renderInventory();
        }
        if (v === "settings") renderCategoryTable();
        if (v === "shopping") renderShopping();
        if (v === "history") renderHistory();
        updateGlobalUI();
      }
      function updateGlobalUI() {
        const c = inventory.filter((i) => i.qty < i.min).length;
        document.getElementById("badge-count").innerText = c;
        c > 0
          ? document
              .getElementById("badge-count")
              .classList.remove("hidden", "scale-0")
          : document
              .getElementById("badge-count")
              .classList.add("hidden", "scale-0");
        document.getElementById("badge-count").classList.add("scale-100");
        if (
          !document
            .getElementById("view-dashboard")
            .classList.contains("hidden")
        )
          updateDashboard();
      }

      initApp();
    </script>
  </body>
</html>
